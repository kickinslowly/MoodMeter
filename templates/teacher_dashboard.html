{% extends "base.html" %}
{% block title %}Teacher Dashboard{% endblock %}
{% block head %}
  <style>
    .dash-container { max-width: 1200px; margin: 0 auto; padding: 16px; }
    .dash-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 16px; }
    .columns { display: grid; grid-template-columns: 2fr 1fr; gap: 16px; }
    .card { background: #1f2227; color: #e8eaeF; padding: 12px; border-radius: 10px; box-shadow: 0 6px 22px rgba(0,0,0,0.45), inset 0 1px 0 rgba(255,255,255,0.06); }
    .filters { display: grid; grid-template-columns: repeat(4, minmax(140px, 1fr)); gap: 8px; margin: 12px 0 12px; }
    .filter-form label { font-size: 12px; opacity: .8; display:block; margin-bottom:4px; }
    .filter-form input, .filter-form select { width: 100%; padding: 6px 8px; border-radius: 8px; border: 1px solid #3a3f47; background: #121418; color: #e8eaef; }
    .btn { background: #2f3540; color: #e8eaef; border: 1px solid #3a3f47; padding: 8px 12px; border-radius: 8px; cursor: pointer; }
    .stats-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
    .grid .cell { position: relative; }
    .heat-count { position: absolute; right: 6px; bottom: 4px; font-size: 12px; color: #fff; text-shadow: 0 1px 2px rgba(0,0,0,0.8); }
    details summary { cursor: pointer; margin-bottom: 8px; }
    /* Hide footer on dashboard pages */
    .footer { display: none !important; }
  </style>
{% endblock %}
{% block content %}
  <script>
    // Progressive enhancement hook + remove footer on dashboard
    (function(){
      try { document.documentElement.classList.add('js'); } catch {}
      const removeFooter = () => {
        const f = document.querySelector('footer.footer');
        if (f) f.remove();
      };
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', removeFooter);
      } else {
        removeFooter();
      }
    })();
  </script>
  <div class="dash-container">
    <div class="dash-header">
      <h1>{% if is_super %}Super Admin Dashboard{% else %}Teacher Dashboard{% endif %}</h1>
      <div style="display:flex; gap:8px; align-items:center;">
        {% if is_super %}<span style="background:#7a2f34;color:#fff;padding:6px 10px;border-radius:8px;border:1px solid #8a3a3f;">Super Admin</span>{% endif %}
        <a class="btn" href="{{ url_for('home') }}">Home</a>
        <a class="btn" href="{{ url_for('moodmeter_dashboard', self=1) }}">Self Report</a>
        <form method="post" action="{{ url_for('logout_view') }}"><button class="btn" type="submit">Logout</button></form>
      </div>
    </div>

    <!-- Tabs UI -->
    <style>
      /* Tabs styling */
      .tabbar { display:flex; gap:8px; margin-bottom:12px; flex-wrap:wrap; }
      .tab-btn { background:#2f3540; color:#e8eaef; border:1px solid #3a3f47; padding:8px 12px; border-radius:8px; cursor:pointer; opacity:.85; }
      .tab-btn.active { opacity:1; box-shadow:0 0 0 2px rgba(255,255,255,0.12) inset; }
      .tab-panels { width:100%; }
      .tab-panel { display:none; width:100%; min-height: calc(100vh - 160px); }
      .tab-panel.active { display:block; }
      /* Hide old two-column layout when tabs are present */
        .js .columns { display:none; }
    </style>

    <div class="tabbar" role="tablist" aria-label="Teacher dashboard sections">
      <button id="tab-group" class="tab-btn" data-tab="group" role="tab" aria-selected="false" aria-controls="panel-group">Group Data</button>
      {% if is_super %}
        <button id="tab-manage-students" class="tab-btn" data-tab="manage-students" role="tab" aria-selected="false" aria-controls="panel-manage-students">Manage Students</button>
        <button id="tab-manage-teachers" class="tab-btn" data-tab="manage-teachers" role="tab" aria-selected="false" aria-controls="panel-manage-teachers">Manage Teachers</button>
      {% else %}
        <button id="tab-manage" class="tab-btn" data-tab="manage" role="tab" aria-selected="false" aria-controls="panel-manage">Manage Groups and Users</button>
      {% endif %}
      <button id="tab-individual" class="tab-btn" data-tab="individual" role="tab" aria-selected="false" aria-controls="panel-individual">Individual Data</button>
    </div>

    <div class="tab-panels">
      <!-- Group Data Panel -->
      <section id="panel-group" class="tab-panel" role="tabpanel" aria-labelledby="tab-group" tabindex="0" data-tab="group">
        <div class="card">
          <form class="filter-form" method="get" action="{{ url_for('moodmeter_dashboard') }}">
            <div class="filters">
              <div>
                <label for="group_id_tab">Group</label>
                <select id="group_id_tab" name="group_id">
                  <option value="">All students (in selected group if chosen)</option>
                  {% for g in groups %}
                    <option value="{{ g.id }}" {% if current_group_id and g.id == current_group_id %}selected{% endif %}>{{ g.name }}</option>
                  {% endfor %}
                </select>
              </div>
              <div>
                <label for="date_from_tab">From date</label>
                <input type="date" id="date_from_tab" name="date_from" value="{{ filters.date_from or '' }}" />
              </div>
              <div>
                <label for="date_to_tab">To date</label>
                <input type="date" id="date_to_tab" name="date_to" value="{{ filters.date_to or '' }}" />
              </div>
              <div style="grid-column: span 4;">
                <details {% if filters.time_from or filters.time_to %}open{% endif %}>
                  <summary>Time options (UTC)</summary>
                  <div style="display:grid; grid-template-columns: repeat(2, minmax(140px, 1fr)); gap:8px; margin-top:8px;">
                    <div>
                      <label for="time_from_tab">From time (UTC)</label>
                      <input type="time" id="time_from_tab" name="time_from" value="{{ filters.time_from or '' }}" />
                    </div>
                    <div>
                      <label for="time_to_tab">To time (UTC)</label>
                      <input type="time" id="time_to_tab" name="time_to" value="{{ filters.time_to or '' }}" />
                    </div>
                  </div>
                </details>
              </div>
              <div style="grid-column: span 4; display:flex; gap:8px;">
                <button class="btn" type="submit">Apply filters</button>
                <a class="btn" href="{{ url_for('moodmeter_dashboard') }}">Reset</a>
              </div>
            </div>
          </form>

          <div class="stats-grid">
            <div class="card"><strong>Most common mood:</strong> {{ stats.most_common_mood or '—' }}</div>
            <div class="card"><strong>Best hour (UTC):</strong> {{ stats.best_hour if stats.best_hour is not none else '—' }}</div>
            <div class="card"><strong>Worst hour (UTC):</strong> {{ stats.worst_hour if stats.worst_hour is not none else '—' }}</div>
            <div class="card"><strong>Best month:</strong> {{ stats.best_month if stats.best_month is not none else '—' }}</div>
            <div class="card"><strong>Worst month:</strong> {{ stats.worst_month if stats.worst_month is not none else '—' }}</div>
            <div class="card"><strong>Best day of week (0=Mon):</strong> {{ stats.best_dow if stats.best_dow is not none else '—' }}</div>
            <div class="card"><strong>Worst day of week (0=Mon):</strong> {{ stats.worst_dow if stats.worst_dow is not none else '—' }}</div>
          </div>

          <div class="card" style="margin-top:12px;">
            <h3 style="margin-bottom:10px">Group heatmap</h3>
            <div class="axes-layout">
              <div class="axis-y" aria-hidden="true">
                <svg class="axis-y-svg" viewBox="0 0 16 100" preserveAspectRatio="none" focusable="false" aria-hidden="true">
                  <defs>
                    <marker id="arrowhead-y" markerWidth="6" markerHeight="6" refX="3" refY="3" orient="auto" markerUnits="strokeWidth">
                      <path d="M0,0 L6,3 L0,6 z" fill="currentColor"></path>
                    </marker>
                  </defs>
                  <line x1="8" y1="6" x2="8" y2="94" stroke="currentColor" stroke-width="2" marker-start="url(#arrowhead-y)" marker-end="url(#arrowhead-y)"></line>
                </svg>
                <div class="axis-label axis-label-y">Energy</div>
              </div>
              <div class="grid-wrapper">
                <div class="grid" role="grid" aria-label="Heatmap grid"
                     data-avg-tx="{{ stats.avg_tx if stats.avg_tx is not none else '' }}"
                     data-avg-ty="{{ stats.avg_ty if stats.avg_ty is not none else '' }}"
                     data-date-from="{{ filters.date_from or '' }}"
                     data-date-to="{{ filters.date_to or '' }}"
                     data-time-from="{{ filters.time_from or '' }}"
                     data-time-to="{{ filters.time_to or '' }}"
                     data-group-id="{{ current_group_id or '' }}">
                  {% set maxc = stats.max_count or 0 %}
                  {% for y in range(size) %}
                    <div class="row" role="row">
                      {% for x in range(size) %}
                        {% set c = stats.heatmap[y][x] %}
                        {% set t = (c / maxc) if maxc else 0 %}
                        {% set label = grid[y][x] %}
                        <div class="cell" data-x="{{ x }}" data-y="{{ y }}" data-intensity="{{ t }}" data-count="{{ c }}" data-cell-label="{{ label }}">
                          <span class="cell-label">{{ label }}</span>
                          {% if c %}<span class="heat-count">{{ c }}</span>{% endif %}
                        </div>
                      {% endfor %}
                    </div>
                  {% endfor %}
                </div>
              </div>
              <div class="axis-x" aria-hidden="true">
                <svg class="axis-x-svg" viewBox="0 0 100 16" preserveAspectRatio="none" focusable="false" aria-hidden="true">
                  <defs>
                    <marker id="arrowhead-x" markerWidth="6" markerHeight="6" refX="3" refY="3" orient="auto" markerUnits="strokeWidth">
                      <path d="M0,0 L6,3 L0,6 z" fill="currentColor"></path>
                    </marker>
                  </defs>
                  <line x1="6" y1="8" x2="94" y2="8" stroke="currentColor" stroke-width="2" marker-start="url(#arrowhead-x)" marker-end="url(#arrowhead-x)"></line>
                </svg>
                <div class="axis-label axis-label-x">Pleasantness</div>
              </div>
            </div>
            {% if stats.avg_x is not none %}
            <div class="avg-legend" aria-live="polite">
              {% set quad = stats.avg_quadrant or '' %}
              {% if quad == 'red' %}{% set dot_class = 'q-red' %}
              {% elif quad == 'yellow' %}{% set dot_class = 'q-yellow' %}
              {% elif quad == 'blue' %}{% set dot_class = 'q-blue' %}
              {% else %}{% set dot_class = 'q-green' %}{% endif %}
              <span class="dot {{ dot_class }}"></span>
              <span class="label">Overall average anchor: <strong>{{ stats.avg_quadrant_label }}</strong>{% if stats.avg_meaning %} — {{ stats.avg_meaning }}{% endif %}</span>
            </div>
            {% endif %}
          </div>
        </div>
      </section>

      {% if is_super %}
      <!-- Manage Students Panel (Super) -->
      <section id="panel-manage-students" class="tab-panel" role="tabpanel" aria-labelledby="tab-manage-students" tabindex="0" data-tab="manage-students">
        <div class="card" style="margin-bottom:12px;">
          <details id="createGroupDetailsManageSuper">
            <summary>Create New Group</summary>
            <form method="post" action="{{ url_for('groups_view') }}" style="display:flex; gap:8px; margin-top:8px;">
              <input type="text" name="name" placeholder="Group name" required />
              <button class="btn" type="submit">Create</button>
            </form>
          </details>
        </div>

        <div class="card">
          <h3>Manage members</h3>
          {% if groups %}
            <form id="addMemberForm2" method="post" action="{{ url_for('add_member', group_id=(current_group_id or groups[0].id)) }}" style="display:grid; grid-template-columns: 1fr auto; gap:8px;">
              <div style="display:grid; grid-template-columns: 1fr 1fr 1fr; gap:8px;">
                <div>
                  <label for="manage_group">Target group</label>
                  <select id="manage_group" name="group_id" onchange="document.getElementById('addMemberForm2').action='/moodmeter/groups/' + this.value + '/members'">
                    {% for g in groups %}
                      <option value="{{ g.id }}" {% if current_group_id and g.id == current_group_id %}selected{% endif %}>{{ g.name }}</option>
                    {% endfor %}
                  </select>
                </div>
                <div>
                  <label for="student_select2">Existing student</label>
                  <select id="student_select2">
                    <option value="">-- Choose student --</option>
                    {% for s in all_students %}
                      {% set label = (s.name or s.email) %}
                      <option value="{{ s.email }}">{{ label }}{% if s.name and s.email %} ({{ s.email }}){% endif %}</option>
                    {% endfor %}
                  </select>
                </div>
                <div>
                  <label for="student_email2">Student email</label>
                  <input id="student_email2" type="email" name="email" placeholder="student@email" required />
                </div>
              </div>
              <div style="display:flex; align-items:end;">
                <button class="btn" type="submit">Add</button>
              </div>
            </form>
          {% else %}
            <p>No groups yet.</p>
          {% endif %}
        </div>

        {% if current_group %}
        <div class="card" style="margin-top:12px;">
          <div style="display:flex; align-items:center; justify-content:space-between; gap:8px;">
            <h3 style="margin:0;">Members of {{ current_group.name }}</h3>
            <button class="btn" id="deleteGroupBtn" data-group-id="{{ current_group.id }}" style="background:#7a2f34; border-color:#8a3a3f;">Delete Group</button>
          </div>
          {% if current_members %}
            <div style="overflow:auto; margin-top:10px;">
              <table class="dataframe" style="width:100%; border-collapse:collapse;">
                <thead>
                  <tr>
                    <th style="text-align:left; padding:6px 8px; border-bottom:1px solid #3a3f47;">Name</th>
                    <th style="text-align:left; padding:6px 8px; border-bottom:1px solid #3a3f47;">Email</th>
                    <th style="text-align:left; padding:6px 8px; border-bottom:1px solid #3a3f47;">Actions</th>
                  </tr>
                </thead>
                <tbody>
                  {% for u in current_members %}
                    <tr>
                      <td style="padding:6px 8px; border-bottom:1px solid #2c3138;">{{ u.name or '—' }}</td>
                      <td style="padding:6px 8px; border-bottom:1px solid #2c3138;">{{ u.email }}</td>
                      <td style="padding:6px 8px; border-bottom:1px solid #2c3138;">
                        <button class="btn remove-member" data-student-id="{{ u.id }}" data-group-id="{{ current_group.id }}">Remove</button>
                      </td>
                    </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          {% else %}
            <p style="margin-top:8px;">No members in this group yet.</p>
          {% endif %}
        </div>
        {% endif %}
      </section>

      <!-- Manage Teachers Panel (Super) -->
      <section id="panel-manage-teachers" class="tab-panel" role="tabpanel" aria-labelledby="tab-manage-teachers" tabindex="0" data-tab="manage-teachers">
        <div class="card" style="margin-bottom:12px;">
          <details id="addTeacherDetails">
            <summary>Super: Add New Teacher</summary>
            <form method="post" action="{{ url_for('create_teacher') }}" style="display:grid; grid-template-columns: 1fr 1fr auto; gap:8px; margin-top:8px;">
              <div>
                <label for="teacher_name">Name (optional)</label>
                <input id="teacher_name" type="text" name="name" placeholder="Teacher name" />
              </div>
              <div>
                <label for="teacher_email">Email</label>
                <input id="teacher_email" type="email" name="email" placeholder="teacher@email" required list="user_emails_list" />
              </div>
              <div style="display:flex; align-items:end;">
                <button class="btn" type="submit">Add Teacher</button>
              </div>
            </form>
            <p style="opacity:.8; font-size:12px; margin-top:6px;">If the email already exists, their role will be upgraded to Teacher (unless they are Super).</p>
          </details>
        </div>

        <div class="card" style="margin-bottom:12px;">
          <details id="changeRoleDetails">
            <summary>Super: Change User Role</summary>
            <form id="roleForm" method="post" action="{{ url_for('set_role') }}" style="display:grid; grid-template-columns: 2fr 1fr auto; gap:8px; margin-top:8px;">
              <div>
                <label for="role_email">User email</label>
                <input id="role_email" type="email" name="email" placeholder="user@email" required list="user_emails_list" />
              </div>
              <div>
                <label for="role_select">Set role</label>
                <select id="role_select" name="role" required>
                  <option value="student">Student</option>
                  <option value="teacher">Teacher</option>
                  <option value="super">Super</option>
                </select>
              </div>
              <div style="display:flex; align-items:end; gap:8px;">
                <button class="btn" type="submit">Update Role</button>
              </div>
            </form>
            <p style="opacity:.8; font-size:12px; margin-top:6px;">Note: You can promote any user to Teacher or Super. Avoid demoting existing Supers unless necessary.</p>
            <datalist id="user_emails_list">
              {% for t in all_teachers %}
                {% if t.email %}<option value="{{ t.email }}">{% endif %}
              {% endfor %}
              {% for s in all_students %}
                {% if s.email %}<option value="{{ s.email }}">{% endif %}
              {% endfor %}
            </datalist>
          </details>
        </div>

        {% if groups %}
        <div class="card" style="margin-bottom:12px;">
          <h3>Assign group teacher (Super)</h3>
          <form id="assignTeacherForm" method="post" action="{{ url_for('set_group_teacher', group_id=(current_group_id or groups[0].id)) }}" style="display:grid; grid-template-columns: 1fr auto; gap:8px;">
            <div style="display:grid; grid-template-columns: 1fr 1fr 1fr; gap:8px;">
              <div>
                <label for="assign_group">Target group</label>
                <select id="assign_group" name="group_id" onchange="document.getElementById('assignTeacherForm').action='/moodmeter/groups/' + this.value + '/set-teacher'">
                  {% for g in groups %}
                    <option value="{{ g.id }}" {% if current_group_id and g.id == current_group_id %}selected{% endif %}>{{ g.name }}</option>
                  {% endfor %}
                </select>
              </div>
              <div>
                <label for="teacher_select2">Existing teacher</label>
                <select id="teacher_select2">
                  <option value="">-- Choose teacher --</option>
                  {% for t in all_teachers %}
                    {% set label = (t.name or t.email) %}
                    <option value="{{ t.email }}">{{ label }}{% if t.name and t.email %} ({{ t.email }}){% endif %}</option>
                  {% endfor %}
                </select>
              </div>
              <div>
                <label for="teacher_email2">Teacher email</label>
                <input id="teacher_email2" type="email" name="email" placeholder="teacher@email" required />
              </div>
            </div>
            <div style="display:flex; align-items:end;">
              <button class="btn" type="submit">Assign</button>
            </div>
          </form>
        </div>
        {% endif %}


        {% if all_teachers %}
        <div class="card" style="margin-top:12px;">
          <h3 style="margin:0 0 8px 0;">Teachers</h3>
          <div style="overflow:auto; margin-top:10px;">
            <table class="dataframe" style="width:100%; border-collapse:collapse;">
              <thead>
                <tr>
                  <th style="text-align:left; padding:6px 8px; border-bottom:1px solid #3a3f47;">Name</th>
                  <th style="text-align:left; padding:6px 8px; border-bottom:1px solid #3a3f47;">Email</th>
                  <th style="text-align:left; padding:6px 8px; border-bottom:1px solid #3a3f47;">Groups</th>
                </tr>
              </thead>
              <tbody>
                {% for t in all_teachers %}
                <tr>
                  <td style="padding:6px 8px; border-bottom:1px solid #2c3138;">{{ t.name or '—' }}</td>
                  <td style="padding:6px 8px; border-bottom:1px solid #2c3138;">{{ t.email }}</td>
                  <td style="padding:6px 8px; border-bottom:1px solid #2c3138;">{{ (t.teaching_groups | map(attribute='name') | list | join(', ')) or '—' }}</td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
        {% endif %}
      </section>
      {% endif %}

      {% if not is_super %}
      <!-- Manage Groups and Users Panel -->
      <section id="panel-manage" class="tab-panel" role="tabpanel" aria-labelledby="tab-manage" tabindex="0" data-tab="manage">
        {% if is_super %}
        <div class="card" style="margin-bottom:12px;">
          <details id="addTeacherDetails">
            <summary>Super: Add New Teacher</summary>
            <form method="post" action="{{ url_for('create_teacher') }}" style="display:grid; grid-template-columns: 1fr 1fr auto; gap:8px; margin-top:8px;">
              <div>
                <label for="teacher_name">Name (optional)</label>
                <input id="teacher_name" type="text" name="name" placeholder="Teacher name" />
              </div>
              <div>
                <label for="teacher_email">Email</label>
                <input id="teacher_email" type="email" name="email" placeholder="teacher@email" required list="user_emails_list" />
              </div>
              <div style="display:flex; align-items:end;">
                <button class="btn" type="submit">Add Teacher</button>
              </div>
            </form>
            <p style="opacity:.8; font-size:12px; margin-top:6px;">If the email already exists, their role will be upgraded to Teacher (unless they are Super).</p>
          </details>
        </div>

        <div class="card" style="margin-bottom:12px;">
          <details id="changeRoleDetails">
            <summary>Super: Change User Role</summary>
            <form id="roleForm" method="post" action="{{ url_for('set_role') }}" style="display:grid; grid-template-columns: 2fr 1fr auto; gap:8px; margin-top:8px;">
              <div>
                <label for="role_email">User email</label>
                <input id="role_email" type="email" name="email" placeholder="user@email" required list="user_emails_list" />
              </div>
              <div>
                <label for="role_select">Set role</label>
                <select id="role_select" name="role" required>
                  <option value="student">Student</option>
                  <option value="teacher">Teacher</option>
                  <option value="super">Super</option>
                </select>
              </div>
              <div style="display:flex; align-items:end; gap:8px;">
                <button class="btn" type="submit">Update Role</button>
              </div>
            </form>
            <p style="opacity:.8; font-size:12px; margin-top:6px;">Note: You can promote any user to Teacher or Super. Avoid demoting existing Supers unless necessary.</p>
            <datalist id="user_emails_list">
              {% for t in all_teachers %}
                {% if t.email %}<option value="{{ t.email }}">{% endif %}
              {% endfor %}
              {% for s in all_students %}
                {% if s.email %}<option value="{{ s.email }}">{% endif %}
              {% endfor %}
            </datalist>
          </details>
        </div>
        {% endif %}

        <div class="card" style="margin-bottom:12px;">
          <details id="createGroupDetailsManage">
            <summary>Create New Group</summary>
            <form method="post" action="{{ url_for('groups_view') }}" style="display:flex; gap:8px; margin-top:8px;">
              <input type="text" name="name" placeholder="Group name" required />
              <button class="btn" type="submit">Create</button>
            </form>
          </details>
        </div>

        <div class="card">
          <h3>Manage members</h3>
          {% if groups %}
            <form id="addMemberForm2" method="post" action="{{ url_for('add_member', group_id=(current_group_id or groups[0].id)) }}" style="display:grid; grid-template-columns: 1fr auto; gap:8px;">
              <div style="display:grid; grid-template-columns: 1fr 1fr 1fr; gap:8px;">
                <div>
                  <label for="manage_group">Target group</label>
                  <select id="manage_group" name="group_id" onchange="document.getElementById('addMemberForm2').action='/moodmeter/groups/' + this.value + '/members'">
                    {% for g in groups %}
                      <option value="{{ g.id }}" {% if current_group_id and g.id == current_group_id %}selected{% endif %}>{{ g.name }}</option>
                    {% endfor %}
                  </select>
                </div>
                <div>
                  <label for="student_select2">Existing student</label>
                  <select id="student_select2">
                    <option value="">-- Choose student --</option>
                    {% for s in all_students %}
                      {% set label = (s.name or s.email) %}
                      <option value="{{ s.email }}">{{ label }}{% if s.name and s.email %} ({{ s.email }}){% endif %}</option>
                    {% endfor %}
                  </select>
                </div>
                <div>
                  <label for="student_email2">Student email</label>
                  <input id="student_email2" type="email" name="email" placeholder="student@email" required />
                </div>
              </div>
              <div style="display:flex; align-items:end;">
                <button class="btn" type="submit">Add</button>
              </div>
            </form>
            {% if is_super %}
            <hr style="border:none; border-top:1px solid #2c3138; margin:12px 0;" />
            <h3>Assign group teacher (Super)</h3>
            <form id="assignTeacherForm" method="post" action="{{ url_for('set_group_teacher', group_id=(current_group_id or groups[0].id)) }}" style="display:grid; grid-template-columns: 1fr auto; gap:8px;">
              <div style="display:grid; grid-template-columns: 1fr 1fr 1fr; gap:8px;">
                <div>
                  <label for="assign_group">Target group</label>
                  <select id="assign_group" name="group_id" onchange="document.getElementById('assignTeacherForm').action='/moodmeter/groups/' + this.value + '/set-teacher'">
                    {% for g in groups %}
                      <option value="{{ g.id }}" {% if current_group_id and g.id == current_group_id %}selected{% endif %}>{{ g.name }}</option>
                    {% endfor %}
                  </select>
                </div>
                <div>
                  <label for="teacher_select2">Existing teacher</label>
                  <select id="teacher_select2">
                    <option value="">-- Choose teacher --</option>
                    {% for t in all_teachers %}
                      {% set label = (t.name or t.email) %}
                      <option value="{{ t.email }}">{{ label }}{% if t.name and t.email %} ({{ t.email }}){% endif %}</option>
                    {% endfor %}
                  </select>
                </div>
                <div>
                  <label for="teacher_email2">Teacher email</label>
                  <input id="teacher_email2" type="email" name="email" placeholder="teacher@email" required />
                </div>
              </div>
              <div style="display:flex; align-items:end;">
                <button class="btn" type="submit">Assign</button>
              </div>
            </form>
            {% endif %}
          {% else %}
            <p>No groups yet.</p>
          {% endif %}
          {% if current_group %}
        </div>

        <div class="card" style="margin-top:12px;">
          <h3 style="margin:0 0 8px 0;">Group teacher</h3>
          {% if current_teacher %}
            <div style="overflow:auto; margin-top:6px;">
              <table class="dataframe" style="width:100%; border-collapse:collapse;">
                <thead>
                  <tr>
                    <th style="text-align:left; padding:6px 8px; border-bottom:1px solid #3a3f47;">Name</th>
                    <th style="text-align:left; padding:6px 8px; border-bottom:1px solid #3a3f47;">Email</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td style="padding:6px 8px; border-bottom:1px solid #2c3138;">{{ current_teacher.name or '—' }}</td>
                    <td style="padding:6px 8px; border-bottom:1px solid #2c3138;">{{ current_teacher.email }}</td>
                  </tr>
                </tbody>
              </table>
            </div>
          {% else %}
            <p>No teacher assigned to this group.</p>
          {% endif %}
        </div>

        {% if is_super and all_teachers %}
        <div class="card" style="margin-top:12px;">
          <h3 style="margin:0 0 8px 0;">Teachers</h3>
          <div style="overflow:auto; margin-top:10px;">
            <table class="dataframe" style="width:100%; border-collapse:collapse;">
              <thead>
                <tr>
                  <th style="text-align:left; padding:6px 8px; border-bottom:1px solid #3a3f47;">Name</th>
                  <th style="text-align:left; padding:6px 8px; border-bottom:1px solid #3a3f47;">Email</th>
                </tr>
              </thead>
              <tbody>
                {% for t in all_teachers %}
                <tr>
                  <td style="padding:6px 8px; border-bottom:1px solid #2c3138;">{{ t.name or '—' }}</td>
                  <td style="padding:6px 8px; border-bottom:1px solid #2c3138;">{{ t.email }}</td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
        {% endif %}

        <div class="card" style="margin-top:12px;">
          <div style="display:flex; align-items:center; justify-content:space-between; gap:8px;">
            <h3 style="margin:0;">Members of {{ current_group.name }}</h3>
            <button class="btn" id="deleteGroupBtn" data-group-id="{{ current_group.id }}" style="background:#7a2f34; border-color:#8a3a3f;">Delete Group</button>
          </div>
          {% if current_members %}
            <div style="overflow:auto; margin-top:10px;">
              <table class="dataframe" style="width:100%; border-collapse:collapse;">
                <thead>
                  <tr>
                    <th style="text-align:left; padding:6px 8px; border-bottom:1px solid #3a3f47;">Name</th>
                    <th style="text-align:left; padding:6px 8px; border-bottom:1px solid #3a3f47;">Email</th>
                    <th style="text-align:left; padding:6px 8px; border-bottom:1px solid #3a3f47;">Actions</th>
                  </tr>
                </thead>
                <tbody>
                  {% for u in current_members %}
                    <tr>
                      <td style="padding:6px 8px; border-bottom:1px solid #2c3138;">{{ u.name or '—' }}</td>
                      <td style="padding:6px 8px; border-bottom:1px solid #2c3138;">{{ u.email }}</td>
                      <td style="padding:6px 8px; border-bottom:1px solid #2c3138;">
                        <button class="btn remove-member" data-student-id="{{ u.id }}" data-group-id="{{ current_group.id }}">Remove</button>
                      </td>
                    </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          {% else %}
            <p style="margin-top:8px;">No members in this group yet.</p>
          {% endif %}
        </div>
          {% endif %}
      </section>
      {% endif %}

      <!-- Individual Data Panel -->
      <section id="panel-individual" class="tab-panel" role="tabpanel" aria-labelledby="tab-individual" tabindex="0" data-tab="individual">
        <div class="card">
          <h3>Individual Data</h3>
          <form id="studentSelectForm" method="get" action="{{ url_for('moodmeter_dashboard') }}" style="display:grid; grid-template-columns: 1fr; gap:8px; margin-top:8px;">
            <input type="hidden" name="group_id" value="{{ current_group_id or '' }}" />
            <input type="hidden" name="date_from" value="{{ filters.date_from or '' }}" />
            <input type="hidden" name="date_to" value="{{ filters.date_to or '' }}" />
            <input type="hidden" name="time_from" value="{{ filters.time_from or '' }}" />
            <input type="hidden" name="time_to" value="{{ filters.time_to or '' }}" />

            <label for="userSearch">Search students</label>
            <input id="userSearch" type="text" placeholder="Type to filter by name or email" />

            <label for="userSelect">Select student</label>
            <select id="userSelect" name="student_id" required>
              <option value="">-- Choose a student --</option>
              {% for s in all_students %}
                {% set label = (s.name or s.email) %}
                <option value="{{ s.id }}" {% if student_user and s.id == student_user.id %}selected{% endif %}>{{ label }}{% if s.name and s.email %} ({{ s.email }}){% endif %}</option>
              {% endfor %}
            </select>
            <div style="display:flex; gap:8px;">
              <button class="btn" type="submit">View</button>
              <a class="btn" href="{{ url_for('moodmeter_dashboard') }}#individual">Clear</a>
            </div>
          </form>

          {% if student_user %}
            <div style="margin-top:12px;"><h4>{{ student_user.name or student_user.email }}</h4></div>
          {% endif %}

          {% if student_stats %}
            <div class="stats-grid" style="margin-top:10px;">
              <div class="card"><strong>Most common mood:</strong> {{ student_stats.most_common_mood or '—' }}</div>
              <div class="card"><strong>Best hour:</strong> {{ student_stats.best_hour if student_stats.best_hour is not none else '—' }}</div>
              <div class="card"><strong>Best month:</strong> {{ student_stats.best_month if student_stats.best_month is not none else '—' }}</div>
            </div>
            <div class="axes-layout" style="margin-top:8px;">
              <div class="axis-y" aria-hidden="true">
                <svg class="axis-y-svg" viewBox="0 0 16 100" preserveAspectRatio="none" focusable="false" aria-hidden="true">
                  <defs>
                    <marker id="arrowhead-y" markerWidth="6" markerHeight="6" refX="3" refY="3" orient="auto" markerUnits="strokeWidth">
                      <path d="M0,0 L6,3 L0,6 z" fill="currentColor"></path>
                    </marker>
                  </defs>
                  <line x1="8" y1="6" x2="8" y2="94" stroke="currentColor" stroke-width="2" marker-start="url(#arrowhead-y)" marker-end="url(#arrowhead-y)"></line>
                </svg>
                <div class="axis-label axis-label-y">Energy</div>
              </div>
              <div class="grid-wrapper">
                <div class="grid">
                  {% set maxc = student_stats.max_count or 0 %}
                  {% for y in range(size) %}
                    <div class="row">
                      {% for x in range(size) %}
                        {% set c = student_stats.heatmap[y][x] %}
                        {% set t = (c / maxc) if maxc else 0 %}
                        {% set label = grid[y][x] %}
                        <div class="cell" data-x="{{ x }}" data-y="{{ y }}" data-intensity="{{ t }}">
                          <span class="cell-label">{{ label }}</span>
                          {% if c %}<span class="heat-count">{{ c }}</span>{% endif %}
                        </div>
                      {% endfor %}
                    </div>
                  {% endfor %}
                </div>
              </div>
              <div class="axis-x" aria-hidden="true">
                <svg class="axis-x-svg" viewBox="0 0 100 16" preserveAspectRatio="none" focusable="false" aria-hidden="true">
                  <defs>
                    <marker id="arrowhead-x" markerWidth="6" markerHeight="6" refX="3" refY="3" orient="auto" markerUnits="strokeWidth">
                      <path d="M0,0 L6,3 L0,6 z" fill="currentColor"></path>
                    </marker>
                  </defs>
                  <line x1="6" y1="8" x2="94" y2="8" stroke="currentColor" stroke-width="2" marker-start="url(#arrowhead-x)" marker-end="url(#arrowhead-x)"></line>
                </svg>
                <div class="axis-label axis-label-x">Pleasantness</div>
              </div>
            </div>
          {% endif %}
        </div>
      </section>
    </div>

    <script>
      // Tabs behavior, manage tab actions, and student search filtering
      (function(){
        // Ensure axis arrowheads point outward on both ends
        try { document.querySelectorAll('marker#arrowhead-x, marker#arrowhead-y').forEach(m => m.setAttribute('orient','auto-start-reverse')); } catch {}
        const tabBtns = Array.from(document.querySelectorAll('.tab-btn'));
        const panels = Array.from(document.querySelectorAll('.tab-panel'));
        const allowedTabs = tabBtns.map(b => b.dataset.tab);
        function getCurrentTab(){
          const active = document.querySelector('.tab-panel.active');
          return active ? active.dataset.tab : (allowedTabs[0] || 'group');
        }
        function activate(tab){
          for (const b of tabBtns){
            const isActive = (b.dataset.tab===tab);
            b.classList.toggle('active', isActive);
            b.setAttribute('aria-selected', String(isActive));
            b.setAttribute('tabindex', isActive ? '0' : '-1');
          }
          for (const p of panels){
            const isActive = (p.dataset.tab===tab);
            p.classList.toggle('active', isActive);
            p.setAttribute('aria-hidden', String(!isActive));
            p.setAttribute('tabindex', isActive ? '0' : '-1');
          }
          if (location.hash !== '#' + tab) history.replaceState(null, '', '#' + tab);
          try { localStorage.setItem('teacher_tab', tab); } catch {}
        }
        for (const b of tabBtns){
          b.addEventListener('click', ()=> activate(b.dataset.tab));
          b.addEventListener('keydown', (e)=>{
            const idx = tabBtns.indexOf(b);
            if (e.key === 'ArrowRight'){ e.preventDefault(); (tabBtns[idx+1]||tabBtns[0]).focus(); (tabBtns[idx+1]||tabBtns[0]).click(); }
            else if (e.key === 'ArrowLeft'){ e.preventDefault(); (tabBtns[idx-1]||tabBtns[tabBtns.length-1]).focus(); (tabBtns[idx-1]||tabBtns[tabBtns.length-1]).click(); }
            else if (e.key === 'Home'){ e.preventDefault(); tabBtns[0].focus(); tabBtns[0].click(); }
            else if (e.key === 'End'){ e.preventDefault(); tabBtns[tabBtns.length-1].focus(); tabBtns[tabBtns.length-1].click(); }
          });
        }
        function syncFromHash(){
          const h = (location.hash||'').replace('#','');
          if (allowedTabs.includes(h)) activate(h);
        }
        let initial = (location.hash||'').replace('#','') || (localStorage.getItem('teacher_tab')||allowedTabs[0]||'group');
        if (!allowedTabs.includes(initial)) initial = (allowedTabs[0]||'group');
        activate(initial);
        window.addEventListener('hashchange', syncFromHash);

        // Manage tab: group selection reload to show members
        const manageSelect = document.getElementById('manage_group');
        if (manageSelect){
          manageSelect.addEventListener('change', function(){
            const gid = this.value;
            // keep on the current tab after reload
            const cur = getCurrentTab();
            window.location.href = '/moodmeter/dashboard?group_id=' + encodeURIComponent(gid) + '#' + cur;
          });
        }

        // Manage tab: existing student dropdown populates email field
        const studentSelect2 = document.getElementById('student_select2');
        if (studentSelect2){
          studentSelect2.addEventListener('change', function(){
            const emailInput = document.getElementById('student_email2');
            if (emailInput) emailInput.value = this.value || '';
          });
        }

        // Manage tab: existing teacher dropdown populates email field (super)
        const teacherSelect2 = document.getElementById('teacher_select2');
        if (teacherSelect2){
          teacherSelect2.addEventListener('change', function(){
            const emailInput = document.getElementById('teacher_email2');
            if (emailInput) emailInput.value = this.value || '';
          });
        }

        // Manage tab: intercept Add Member form to use fetch
        const addForm = document.getElementById('addMemberForm2');
        if (addForm){
          addForm.addEventListener('submit', async function(ev){
            ev.preventDefault();
            const fd = new FormData(addForm);
            const gid = (document.getElementById('manage_group')||{}).value || '';
            const email = (document.getElementById('student_email2')||{}).value || '';
            if (!gid || !email){ return; }
            try {
              const resp = await fetch(`/moodmeter/groups/${encodeURIComponent(gid)}/members`, {
                method: 'POST',
                headers: {
                  'Accept': 'application/json',
                  'X-Requested-With': 'XMLHttpRequest',
                  'Content-Type': 'application/x-www-form-urlencoded; charset=UTF-8'
                },
                body: new URLSearchParams({ email })
              });
              const json = await resp.json().catch(()=>({}));
              if (resp.ok && json.ok){
                // force reload to show updated member list (cache-busted)
                const cur = getCurrentTab();
                window.location.assign('/moodmeter/dashboard?group_id=' + encodeURIComponent(gid) + '&r=' + Date.now() + '#' + cur);
              } else {
                alert('Failed to add member' + (json.detail ? (': ' + json.detail) : ''));
              }
            } catch (e){
              alert('Network error while adding member');
            }
          });
        }

        // Manage tab: assign teacher form submit (super)
        const assignForm = document.getElementById('assignTeacherForm');
        if (assignForm){
          assignForm.addEventListener('submit', async function(ev){
            ev.preventDefault();
            const gid = (document.getElementById('assign_group')||{}).value || '';
            const email = (document.getElementById('teacher_email2')||{}).value || '';
            if (!gid || !email){ return; }
            try {
              const resp = await fetch(`/moodmeter/groups/${encodeURIComponent(gid)}/set-teacher`, {
                method: 'POST',
                headers: {
                  'Accept': 'application/json',
                  'X-Requested-With': 'XMLHttpRequest',
                  'Content-Type': 'application/x-www-form-urlencoded; charset=UTF-8'
                },
                body: new URLSearchParams({ email })
              });
              const json = await resp.json().catch(()=>({}));
              if (resp.ok && json.ok){
                const cur = getCurrentTab();
                window.location.assign('/moodmeter/dashboard?group_id=' + encodeURIComponent(gid) + '&r=' + Date.now() + '#' + cur);
              } else {
                alert('Failed to assign teacher' + (json.detail ? (': ' + json.detail) : ''));
              }
            } catch (e){
              alert('Network error while assigning teacher');
            }
          });
        }

        // Manage tab: change user role (super)
        const roleForm = document.getElementById('roleForm');
        if (roleForm){
          roleForm.addEventListener('submit', async function(ev){
            ev.preventDefault();
            const email = (document.getElementById('role_email')||{}).value || '';
            const role = (document.getElementById('role_select')||{}).value || '';
            if (!email || !role){ return; }
            try {
              const resp = await fetch(`/role`, {
                method: 'POST',
                headers: {
                  'Accept': 'application/json',
                  'X-Requested-With': 'XMLHttpRequest',
                  'Content-Type': 'application/x-www-form-urlencoded; charset=UTF-8'
                },
                body: new URLSearchParams({ email, role })
              });
              const json = await resp.json().catch(()=>({}));
              if (resp.ok && json.ok){
                alert('Role updated: ' + (json.email || email) + ' → ' + (json.role || role));
                // stay on the current tab
                const cur = getCurrentTab();
                if (location.hash !== '#' + cur) location.hash = '#' + cur;
              } else {
                alert('Failed to update role' + (json.detail ? (': ' + json.detail) : ''));
              }
            } catch (e){
              alert('Network error while updating role');
            }
          });
        }

        // Manage tab: remove member buttons
        document.addEventListener('click', async function(ev){
          const btn = ev.target.closest('.remove-member');
          if (!btn) return;
          const gid = btn.getAttribute('data-group-id');
          const sid = btn.getAttribute('data-student-id');
          if (!gid || !sid) return;
          if (!confirm('Remove this user from the group?')) return;
          try {
            const resp = await fetch(`/moodmeter/groups/${encodeURIComponent(gid)}/members/${encodeURIComponent(sid)}/remove`, {
              method: 'POST',
              headers: {
                'Accept': 'application/json',
                'X-Requested-With': 'XMLHttpRequest'
              }
            });
            const json = await resp.json().catch(()=>({}));
            if (resp.ok && json.ok){
              const cur = getCurrentTab();
              window.location.assign('/moodmeter/dashboard?group_id=' + encodeURIComponent(gid) + '&r=' + Date.now() + '#' + cur);
            } else {
              alert('Failed to remove member' + (json.detail ? (': ' + json.detail) : ''));
            }
          } catch (e){
            alert('Network error while removing member');
          }
        });

        // Manage tab: delete group
        const delBtn = document.getElementById('deleteGroupBtn');
        if (delBtn){
          delBtn.addEventListener('click', async function(){
            const gid = this.getAttribute('data-group-id');
            if (!gid) return;
            if (!confirm('Delete this group and remove all its memberships?')) return;
            try {
              const resp = await fetch(`/moodmeter/groups/${encodeURIComponent(gid)}/delete`, {
                method: 'POST',
                headers: {
                  'Accept': 'application/json',
                  'X-Requested-With': 'XMLHttpRequest'
                }
              });
              const json = await resp.json().catch(()=>({}));
              if (resp.ok && json.ok){
                const cur = getCurrentTab();
                window.location.assign('/moodmeter/dashboard?r=' + Date.now() + '#' + cur);
              } else {
                alert('Failed to delete group' + (json.detail ? (': ' + json.detail) : ''));
              }
            } catch (e){
              alert('Network error while deleting group');
            }
          });
        }

        // Individual search filter
        const search = document.getElementById('userSearch');
        const select = document.getElementById('userSelect');
        if (search && select){
          const all = Array.from(select.querySelectorAll('option')).map(o => ({ value:o.value, text:o.textContent }));
          function applyFilter(){
            const q = (search.value||'').toLowerCase().trim();
            const filtered = q ? all.filter(o => o.text.toLowerCase().includes(q)) : all;
            const current = select.value;
            select.innerHTML = '';
            for (const o of filtered){
              const opt = document.createElement('option');
              opt.value = o.value; opt.textContent = o.text; select.appendChild(opt);
            }
            if (filtered.some(o => o.value===current)) select.value = current; else select.value = '';
          }
          search.addEventListener('input', applyFilter);
        }
      })();
    </script>

    <div class="columns">
      <div class="card">
        <form class="filter-form" method="get" action="{{ url_for('moodmeter_dashboard') }}">
          <div class="filters">
            <div>
              <label for="group_id">Group</label>
              <select id="group_id" name="group_id">
                <option value="">All students (in selected group if chosen)</option>
                {% for g in groups %}
                  <option value="{{ g.id }}" {% if current_group_id and g.id == current_group_id %}selected{% endif %}>{{ g.name }}</option>
                {% endfor %}
              </select>
            </div>
            <div>
              <label for="date_from">From date</label>
              <input type="date" id="date_from" name="date_from" value="{{ filters.date_from or '' }}" />
            </div>
            <div>
              <label for="date_to">To date</label>
              <input type="date" id="date_to" name="date_to" value="{{ filters.date_to or '' }}" />
            </div>
            <div style="grid-column: span 4;">
              <details {% if filters.time_from or filters.time_to %}open{% endif %}>
                <summary>Time options (UTC)</summary>
                <div style="display:grid; grid-template-columns: repeat(2, minmax(140px, 1fr)); gap:8px; margin-top:8px;">
                  <div>
                    <label for="time_from">From time (UTC)</label>
                    <input type="time" id="time_from" name="time_from" value="{{ filters.time_from or '' }}" />
                  </div>
                  <div>
                    <label for="time_to">To time (UTC)</label>
                    <input type="time" id="time_to" name="time_to" value="{{ filters.time_to or '' }}" />
                  </div>
                </div>
              </details>
            </div>
            <div style="grid-column: span 4; display:flex; gap:8px;">
              <button class="btn" type="submit">Apply filters</button>
              <a class="btn" href="{{ url_for('moodmeter_dashboard') }}">Reset</a>
            </div>
          </div>
        </form>

        <div class="stats-grid">
          <div class="card"><strong>Most common mood:</strong> {{ stats.most_common_mood or '—' }}</div>
          <div class="card"><strong>Best hour (UTC):</strong> {{ stats.best_hour if stats.best_hour is not none else '—' }}</div>
          <div class="card"><strong>Worst hour (UTC):</strong> {{ stats.worst_hour if stats.worst_hour is not none else '—' }}</div>
          <div class="card"><strong>Best month:</strong> {{ stats.best_month if stats.best_month is not none else '—' }}</div>
          <div class="card"><strong>Worst month:</strong> {{ stats.worst_month if stats.worst_month is not none else '—' }}</div>
          <div class="card"><strong>Best day of week (0=Mon):</strong> {{ stats.best_dow if stats.best_dow is not none else '—' }}</div>
          <div class="card"><strong>Worst day of week (0=Mon):</strong> {{ stats.worst_dow if stats.worst_dow is not none else '—' }}</div>
        </div>

        <div class="card" style="margin-top:12px;">
          <h3 style="margin-bottom:10px">Group heatmap</h3>
          <div class="axes-layout">
            <div class="axis-y" aria-hidden="true">
              <svg class="axis-y-svg" viewBox="0 0 16 100" preserveAspectRatio="none" focusable="false" aria-hidden="true">
                <defs>
                  <marker id="arrowhead-y" markerWidth="6" markerHeight="6" refX="3" refY="3" orient="auto" markerUnits="strokeWidth">
                    <path d="M0,0 L6,3 L0,6 z" fill="currentColor"></path>
                  </marker>
                </defs>
                <line x1="8" y1="6" x2="8" y2="94" stroke="currentColor" stroke-width="2" marker-start="url(#arrowhead-y)" marker-end="url(#arrowhead-y)"></line>
              </svg>
              <div class="axis-label axis-label-y">Energy</div>
            </div>
            <div class="grid-wrapper">
              <div class="grid" role="grid" aria-label="Heatmap grid"
                   data-date-from="{{ filters.date_from or '' }}"
                   data-date-to="{{ filters.date_to or '' }}"
                   data-time-from="{{ filters.time_from or '' }}"
                   data-time-to="{{ filters.time_to or '' }}"
                   data-group-id="{{ current_group_id or '' }}">
                {% set maxc = stats.max_count or 0 %}
                {% for y in range(size) %}
                  <div class="row" role="row">
                    {% for x in range(size) %}
                      {% set c = stats.heatmap[y][x] %}
                      {% set t = (c / maxc) if maxc else 0 %}
                      {% set label = grid[y][x] %}
                      <div class="cell" data-x="{{ x }}" data-y="{{ y }}" data-intensity="{{ t }}" data-count="{{ c }}" data-cell-label="{{ label }}">
                        <span class="cell-label">{{ label }}</span>
                        {% if c %}<span class="heat-count">{{ c }}</span>{% endif %}
                      </div>
                    {% endfor %}
                  </div>
                {% endfor %}
              </div>
            </div>
            <div class="axis-x" aria-hidden="true">
              <svg class="axis-x-svg" viewBox="0 0 100 16" preserveAspectRatio="none" focusable="false" aria-hidden="true">
                <defs>
                  <marker id="arrowhead-x" markerWidth="6" markerHeight="6" refX="3" refY="3" orient="auto" markerUnits="strokeWidth">
                    <path d="M0,0 L6,3 L0,6 z" fill="currentColor"></path>
                  </marker>
                </defs>
                <line x1="6" y1="8" x2="94" y2="8" stroke="currentColor" stroke-width="2" marker-start="url(#arrowhead-x)" marker-end="url(#arrowhead-x)"></line>
              </svg>
              <div class="axis-label axis-label-x">Pleasantness</div>
            </div>
          </div>
        </div>
      </div>

      <div>
        <div class="card" style="margin-bottom:12px;">
          <details id="createGroupDetailsLegacy">
            <summary>Create New Group</summary>
            <form method="post" action="{{ url_for('groups_view') }}" style="display:flex; gap:8px; margin-top:8px;">
              <input type="text" name="name" placeholder="Group name" required />
              <button class="btn" type="submit">Create</button>
            </form>
          </details>
        </div>

        <div class="card">
          <h3>Manage members</h3>
          {% if groups %}
            <p style="margin:6px 0 8px;">Add student by email to selected group:</p>
            <form id="addMemberForm" method="post" action="{{ url_for('add_member', group_id=(current_group_id or groups[0].id)) }}" style="display:flex; gap:8px;">
              <input type="email" name="email" placeholder="student@email" required />
              <button class="btn" type="submit">Add</button>
            </form>
            <p style="opacity:.7; font-size:12px; margin-top:8px;">Tip: Select a group at left first to target additions.</p>
          {% else %}
            <p>No groups yet.</p>
          {% endif %}
        </div>

        <div class="card" style="margin-top:12px;">
          <details>
            <summary>View individual student</summary>
            <form method="get" action="{{ url_for('moodmeter_dashboard') }}" style="display:grid; grid-template-columns: 1fr; gap:8px; margin-top:8px;">
              <input type="hidden" name="group_id" value="{{ current_group_id or '' }}" />
              <label>Email to view (must exist):</label>
              <input type="text" name="student_email" placeholder="student@email" />
              <div style="display:flex; gap:8px;">
                <button class="btn" type="submit">Load</button>
                <a class="btn" href="{{ url_for('moodmeter_dashboard', group_id=current_group_id) }}">Clear</a>
              </div>
            </form>
            {% if request.args.get('student_email') %}
              {% set s = (all_students|selectattr('email','equalto', request.args.get('student_email'))|list|first) %}
              {% if s %}
                <div style="margin-top:12px;">
                  <h4>{{ s.name or s.email }}</h4>
                </div>
              {% else %}
                <p style="color:#f99">Student not found.</p>
              {% endif %}
            {% endif %}
            {% if student_stats %}
              <div class="stats-grid" style="margin-top:10px;">
                <div class="card"><strong>Most common mood:</strong> {{ student_stats.most_common_mood or '—' }}</div>
                <div class="card"><strong>Best hour:</strong> {{ student_stats.best_hour if student_stats.best_hour is not none else '—' }}</div>
                <div class="card"><strong>Best month:</strong> {{ student_stats.best_month if student_stats.best_month is not none else '—' }}</div>
              </div>
              <div class="axes-layout" style="margin-top:8px;">
                <div class="axis-y" aria-hidden="true">
                  <svg class="axis-y-svg" viewBox="0 0 16 100" preserveAspectRatio="none" focusable="false" aria-hidden="true">
                    <defs>
                      <marker id="arrowhead-y" markerWidth="6" markerHeight="6" refX="3" refY="3" orient="auto" markerUnits="strokeWidth">
                        <path d="M0,0 L6,3 L0,6 z" fill="currentColor"></path>
                      </marker>
                    </defs>
                    <line x1="8" y1="6" x2="8" y2="94" stroke="currentColor" stroke-width="2" marker-start="url(#arrowhead-y)" marker-end="url(#arrowhead-y)"></line>
                  </svg>
                  <div class="axis-label axis-label-y">Energy</div>
                </div>
                <div class="grid-wrapper">
                  <div class="grid"
                       data-avg-tx="{{ student_stats.avg_tx if student_stats.avg_tx is not none else '' }}"
                       data-avg-ty="{{ student_stats.avg_ty if student_stats.avg_ty is not none else '' }}"
                       data-date-from="{{ filters.date_from or '' }}"
                       data-date-to="{{ filters.date_to or '' }}"
                       data-time-from="{{ filters.time_from or '' }}"
                       data-time-to="{{ filters.time_to or '' }}"
                       data-student-id="{{ student_user.id if student_user else '' }}">
                    {% set maxc = student_stats.max_count or 0 %}
                    {% for y in range(size) %}
                      <div class="row">
                        {% for x in range(size) %}
                          {% set c = student_stats.heatmap[y][x] %}
                          {% set t = (c / maxc) if maxc else 0 %}
                          {% set label = grid[y][x] %}
                          <div class="cell" data-x="{{ x }}" data-y="{{ y }}" data-intensity="{{ t }}" data-count="{{ c }}" data-cell-label="{{ label }}">
                            <span class="cell-label">{{ label }}</span>
                            {% if c %}<span class="heat-count">{{ c }}</span>{% endif %}
                          </div>
                        {% endfor %}
                      </div>
                    {% endfor %}
                  </div>
                </div>
                <div class="axis-x" aria-hidden="true">
                  <svg class="axis-x-svg" viewBox="0 0 100 16" preserveAspectRatio="none" focusable="false" aria-hidden="true">
                    <defs>
                      <marker id="arrowhead-x" markerWidth="6" markerHeight="6" refX="3" refY="3" orient="auto" markerUnits="strokeWidth">
                        <path d="M0,0 L6,3 L0,6 z" fill="currentColor"></path>
                      </marker>
                    </defs>
                    <line x1="6" y1="8" x2="94" y2="8" stroke="currentColor" stroke-width="2" marker-start="url(#arrowhead-x)" marker-end="url(#arrowhead-x)"></line>
                  </svg>
                  <div class="axis-label axis-label-x">Pleasantness</div>
                </div>
              </div>
              {% if student_stats and student_stats.avg_x is not none %}
              <div class="avg-legend" aria-live="polite">
                {% set quad = student_stats.avg_quadrant or '' %}
                {% if quad == 'red' %}{% set dot_class = 'q-red' %}
                {% elif quad == 'yellow' %}{% set dot_class = 'q-yellow' %}
                {% elif quad == 'blue' %}{% set dot_class = 'q-blue' %}
                {% else %}{% set dot_class = 'q-green' %}{% endif %}
                <span class="dot {{ dot_class }}"></span>
                <span class="label">Overall average anchor: <strong>{{ student_stats.avg_quadrant_label }}</strong>{% if student_stats.avg_meaning %} — {{ student_stats.avg_meaning }}{% endif %}</span>
              </div>
              {% endif %}
            {% endif %}
          </details>
        </div>
      </div>
    </div>
  </div>
{% endblock %}
{% block scripts %}
  <script src="{{ url_for('static', filename='js/heatmap-colors.js') }}"></script>
  <script src="{{ url_for('static', filename='js/cell-modal.js') }}"></script>
  <script>
    (function() {
      var size = Number('{{ size|tojson }}');
      function ready(fn){ if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', fn); else fn(); }
      ready(function(){
        window.initHeatmap(size);
        window.initCellModal();
      });
    })();
  </script>
{% endblock %}
