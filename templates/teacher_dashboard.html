<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Teacher Dashboard</title>
  <link rel="stylesheet" href="https://unpkg.com/modern-css-reset/dist/reset.min.css">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}" />
  <style>
    .dash-container { max-width: 1200px; margin: 0 auto; padding: 16px; }
    .dash-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 16px; }
    .columns { display: grid; grid-template-columns: 2fr 1fr; gap: 16px; }
    .card { background: #1f2227; color: #e8eaeF; padding: 12px; border-radius: 10px; box-shadow: 0 6px 22px rgba(0,0,0,0.45), inset 0 1px 0 rgba(255,255,255,0.06); }
    .filters { display: grid; grid-template-columns: repeat(4, minmax(140px, 1fr)); gap: 8px; margin: 12px 0 12px; }
    .filter-form label { font-size: 12px; opacity: .8; display:block; margin-bottom:4px; }
    .filter-form input, .filter-form select { width: 100%; padding: 6px 8px; border-radius: 8px; border: 1px solid #3a3f47; background: #121418; color: #e8eaef; }
    .btn { background: #2f3540; color: #e8eaef; border: 1px solid #3a3f47; padding: 8px 12px; border-radius: 8px; cursor: pointer; }
    .stats-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
    .grid .cell { position: relative; }
    .heat-count { position: absolute; right: 6px; bottom: 4px; font-size: 12px; color: #fff; text-shadow: 0 1px 2px rgba(0,0,0,0.8); }
    details summary { cursor: pointer; margin-bottom: 8px; }
    /* Hide footer on dashboard pages */
    .footer { display: none !important; }
  </style>
</head>
<body>
  <script>
    // Ensure no footer element exists on this dashboard page
    (function(){
      const removeFooter = () => {
        const f = document.querySelector('footer.footer');
        if (f) f.remove();
      };
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', removeFooter);
      } else {
        removeFooter();
      }
    })();
  </script>
  <div class="dash-container">
    <div class="dash-header">
      <h1>Teacher Dashboard</h1>
      <div style="display:flex; gap:8px; align-items:center;">
        <a class="btn" href="{{ url_for('index') }}">Mood Meter</a>
        <a class="btn" href="{{ url_for('dashboard', self=1) }}">Self Report</a>
        <form method="post" action="{{ url_for('logout_view') }}"><button class="btn" type="submit">Logout</button></form>
      </div>
    </div>

    <!-- Tabs UI -->
    <style>
      /* Tabs styling */
      .tabbar { display:flex; gap:8px; margin-bottom:12px; flex-wrap:wrap; }
      .tab-btn { background:#2f3540; color:#e8eaef; border:1px solid #3a3f47; padding:8px 12px; border-radius:8px; cursor:pointer; opacity:.85; }
      .tab-btn.active { opacity:1; box-shadow:0 0 0 2px rgba(255,255,255,0.12) inset; }
      .tab-panels { width:100%; }
      .tab-panel { display:none; width:100%; min-height: calc(100vh - 160px); }
      .tab-panel.active { display:block; }
      /* Hide old two-column layout when tabs are present */
      .columns { display:none; }
    </style>

    <div class="tabbar" role="tablist" aria-label="Teacher dashboard sections">
      <button class="tab-btn" data-tab="group" role="tab" aria-selected="true">Group Data</button>
      <button class="tab-btn" data-tab="manage" role="tab" aria-selected="false">Manage Groups and Users</button>
      <button class="tab-btn" data-tab="individual" role="tab" aria-selected="false">Individual Data</button>
    </div>

    <div class="tab-panels">
      <!-- Group Data Panel -->
      <section class="tab-panel" data-tab="group">
        <div class="card">
          <form class="filter-form" method="get" action="{{ url_for('dashboard') }}">
            <div class="filters">
              <div>
                <label for="group_id_tab">Group</label>
                <select id="group_id_tab" name="group_id">
                  <option value="">All students (in selected group if chosen)</option>
                  {% for g in groups %}
                    <option value="{{ g.id }}" {% if current_group_id and g.id == current_group_id %}selected{% endif %}>{{ g.name }}</option>
                  {% endfor %}
                </select>
              </div>
              <div>
                <label for="date_from_tab">From date</label>
                <input type="date" id="date_from_tab" name="date_from" value="{{ filters.date_from or '' }}" />
              </div>
              <div>
                <label for="date_to_tab">To date</label>
                <input type="date" id="date_to_tab" name="date_to" value="{{ filters.date_to or '' }}" />
              </div>
              <div style="grid-column: span 4;">
                <details {% if filters.time_from or filters.time_to %}open{% endif %}>
                  <summary>Time options (UTC)</summary>
                  <div style="display:grid; grid-template-columns: repeat(2, minmax(140px, 1fr)); gap:8px; margin-top:8px;">
                    <div>
                      <label for="time_from_tab">From time (UTC)</label>
                      <input type="time" id="time_from_tab" name="time_from" value="{{ filters.time_from or '' }}" />
                    </div>
                    <div>
                      <label for="time_to_tab">To time (UTC)</label>
                      <input type="time" id="time_to_tab" name="time_to" value="{{ filters.time_to or '' }}" />
                    </div>
                  </div>
                </details>
              </div>
              <div style="grid-column: span 4; display:flex; gap:8px;">
                <button class="btn" type="submit">Apply filters</button>
                <a class="btn" href="{{ url_for('dashboard') }}">Reset</a>
              </div>
            </div>
          </form>

          <div class="stats-grid">
            <div class="card"><strong>Most common mood:</strong> {{ stats.most_common_mood or '—' }}</div>
            <div class="card"><strong>Best hour (UTC):</strong> {{ stats.best_hour if stats.best_hour is not none else '—' }}</div>
            <div class="card"><strong>Worst hour (UTC):</strong> {{ stats.worst_hour if stats.worst_hour is not none else '—' }}</div>
            <div class="card"><strong>Best month:</strong> {{ stats.best_month if stats.best_month is not none else '—' }}</div>
            <div class="card"><strong>Worst month:</strong> {{ stats.worst_month if stats.worst_month is not none else '—' }}</div>
            <div class="card"><strong>Best day of week (0=Mon):</strong> {{ stats.best_dow if stats.best_dow is not none else '—' }}</div>
            <div class="card"><strong>Worst day of week (0=Mon):</strong> {{ stats.worst_dow if stats.worst_dow is not none else '—' }}</div>
          </div>

          <div class="card" style="margin-top:12px;">
            <h3 style="margin-bottom:10px">Group heatmap</h3>
            <div class="axes-layout">
              <div class="axis-y" aria-hidden="true">
                <svg class="axis-y-svg" viewBox="0 0 16 100" preserveAspectRatio="none" focusable="false" aria-hidden="true">
                  <defs>
                    <marker id="arrowhead-y" markerWidth="6" markerHeight="6" refX="3" refY="3" orient="auto" markerUnits="strokeWidth">
                      <path d="M0,0 L6,3 L0,6 z" fill="currentColor"></path>
                    </marker>
                  </defs>
                  <line x1="8" y1="6" x2="8" y2="94" stroke="currentColor" stroke-width="2" marker-start="url(#arrowhead-y)" marker-end="url(#arrowhead-y)"></line>
                </svg>
                <div class="axis-label axis-label-y">Energy</div>
              </div>
              <div class="grid-wrapper">
                <div class="grid" role="grid" aria-label="Heatmap grid"
                     data-avg-tx="{{ stats.avg_tx if stats.avg_tx is not none else '' }}"
                     data-avg-ty="{{ stats.avg_ty if stats.avg_ty is not none else '' }}"
                     data-date-from="{{ filters.date_from or '' }}"
                     data-date-to="{{ filters.date_to or '' }}"
                     data-time-from="{{ filters.time_from or '' }}"
                     data-time-to="{{ filters.time_to or '' }}"
                     data-group-id="{{ current_group_id or '' }}">
                  {% set maxc = stats.max_count or 0 %}
                  {% for y in range(size) %}
                    <div class="row" role="row">
                      {% for x in range(size) %}
                        {% set c = stats.heatmap[y][x] %}
                        {% set t = (c / maxc) if maxc else 0 %}
                        {% set label = grid[y][x] %}
                        <div class="cell" data-x="{{ x }}" data-y="{{ y }}" data-intensity="{{ t }}" data-count="{{ c }}" data-cell-label="{{ label }}">
                          <span class="cell-label">{{ label }}</span>
                          {% if c %}<span class="heat-count">{{ c }}</span>{% endif %}
                        </div>
                      {% endfor %}
                    </div>
                  {% endfor %}
                </div>
              </div>
              <div class="axis-x" aria-hidden="true">
                <svg class="axis-x-svg" viewBox="0 0 100 16" preserveAspectRatio="none" focusable="false" aria-hidden="true">
                  <defs>
                    <marker id="arrowhead-x" markerWidth="6" markerHeight="6" refX="3" refY="3" orient="auto" markerUnits="strokeWidth">
                      <path d="M0,0 L6,3 L0,6 z" fill="currentColor"></path>
                    </marker>
                  </defs>
                  <line x1="6" y1="8" x2="94" y2="8" stroke="currentColor" stroke-width="2" marker-start="url(#arrowhead-x)" marker-end="url(#arrowhead-x)"></line>
                </svg>
                <div class="axis-label axis-label-x">Pleasantness</div>
              </div>
            </div>
            {% if stats.avg_x is not none %}
            <div class="avg-legend" aria-live="polite">
              {% set quad = stats.avg_quadrant or '' %}
              {% if quad == 'red' %}{% set dot_class = 'q-red' %}
              {% elif quad == 'yellow' %}{% set dot_class = 'q-yellow' %}
              {% elif quad == 'blue' %}{% set dot_class = 'q-blue' %}
              {% else %}{% set dot_class = 'q-green' %}{% endif %}
              <span class="dot {{ dot_class }}"></span>
              <span class="label">Overall average anchor: <strong>{{ stats.avg_quadrant_label }}</strong>{% if stats.avg_meaning %} — {{ stats.avg_meaning }}{% endif %}</span>
            </div>
            {% endif %}
          </div>
        </div>
      </section>

      <!-- Manage Groups and Users Panel -->
      <section class="tab-panel" data-tab="manage">
        <div class="card" style="margin-bottom:12px;">
          <details id="createGroupDetailsManage">
            <summary>Create New Group</summary>
            <form method="post" action="{{ url_for('groups_view') }}" style="display:flex; gap:8px; margin-top:8px;">
              <input type="text" name="name" placeholder="Group name" required />
              <button class="btn" type="submit">Create</button>
            </form>
          </details>
        </div>

        <div class="card">
          <h3>Manage members</h3>
          {% if groups %}
            <form id="addMemberForm2" method="post" action="{{ url_for('add_member', group_id=(current_group_id or groups[0].id)) }}" style="display:grid; grid-template-columns: 1fr auto; gap:8px;">
              <div style="display:grid; grid-template-columns: 1fr 1fr 1fr; gap:8px;">
                <div>
                  <label for="manage_group">Target group</label>
                  <select id="manage_group" name="group_id" onchange="document.getElementById('addMemberForm2').action='/groups/' + this.value + '/members'">
                    {% for g in groups %}
                      <option value="{{ g.id }}" {% if current_group_id and g.id == current_group_id %}selected{% endif %}>{{ g.name }}</option>
                    {% endfor %}
                  </select>
                </div>
                <div>
                  <label for="student_select2">Existing student</label>
                  <select id="student_select2">
                    <option value="">-- Choose student --</option>
                    {% for s in all_students %}
                      {% set label = (s.name or s.email) %}
                      <option value="{{ s.email }}">{{ label }}{% if s.name and s.email %} ({{ s.email }}){% endif %}</option>
                    {% endfor %}
                  </select>
                </div>
                <div>
                  <label for="student_email2">Student email</label>
                  <input id="student_email2" type="email" name="email" placeholder="student@email" required />
                </div>
              </div>
              <div style="display:flex; align-items:end;">
                <button class="btn" type="submit">Add</button>
              </div>
            </form>
          {% else %}
            <p>No groups yet.</p>
          {% endif %}
          {% if current_group %}
        </div>

        <div class="card" style="margin-top:12px;">
          <div style="display:flex; align-items:center; justify-content:space-between; gap:8px;">
            <h3 style="margin:0;">Members of {{ current_group.name }}</h3>
            <button class="btn" id="deleteGroupBtn" data-group-id="{{ current_group.id }}" style="background:#7a2f34; border-color:#8a3a3f;">Delete Group</button>
          </div>
          {% if current_members %}
            <div style="overflow:auto; margin-top:10px;">
              <table class="dataframe" style="width:100%; border-collapse:collapse;">
                <thead>
                  <tr>
                    <th style="text-align:left; padding:6px 8px; border-bottom:1px solid #3a3f47;">Name</th>
                    <th style="text-align:left; padding:6px 8px; border-bottom:1px solid #3a3f47;">Email</th>
                    <th style="text-align:left; padding:6px 8px; border-bottom:1px solid #3a3f47;">Actions</th>
                  </tr>
                </thead>
                <tbody>
                  {% for u in current_members %}
                    <tr>
                      <td style="padding:6px 8px; border-bottom:1px solid #2c3138;">{{ u.name or '—' }}</td>
                      <td style="padding:6px 8px; border-bottom:1px solid #2c3138;">{{ u.email }}</td>
                      <td style="padding:6px 8px; border-bottom:1px solid #2c3138;">
                        <button class="btn remove-member" data-student-id="{{ u.id }}" data-group-id="{{ current_group.id }}">Remove</button>
                      </td>
                    </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          {% else %}
            <p style="margin-top:8px;">No members in this group yet.</p>
          {% endif %}
        </div>
          {% endif %}
      </section>

      <!-- Individual Data Panel -->
      <section class="tab-panel" data-tab="individual">
        <div class="card">
          <h3>Individual Data</h3>
          <form id="studentSelectForm" method="get" action="{{ url_for('dashboard') }}" style="display:grid; grid-template-columns: 1fr; gap:8px; margin-top:8px;">
            <input type="hidden" name="group_id" value="{{ current_group_id or '' }}" />
            <input type="hidden" name="date_from" value="{{ filters.date_from or '' }}" />
            <input type="hidden" name="date_to" value="{{ filters.date_to or '' }}" />
            <input type="hidden" name="time_from" value="{{ filters.time_from or '' }}" />
            <input type="hidden" name="time_to" value="{{ filters.time_to or '' }}" />

            <label for="userSearch">Search students</label>
            <input id="userSearch" type="text" placeholder="Type to filter by name or email" />

            <label for="userSelect">Select student</label>
            <select id="userSelect" name="student_id" required>
              <option value="">-- Choose a student --</option>
              {% for s in all_students %}
                {% set label = (s.name or s.email) %}
                <option value="{{ s.id }}" {% if student_user and s.id == student_user.id %}selected{% endif %}>{{ label }}{% if s.name and s.email %} ({{ s.email }}){% endif %}</option>
              {% endfor %}
            </select>
            <div style="display:flex; gap:8px;">
              <button class="btn" type="submit">View</button>
              <a class="btn" href="{{ url_for('dashboard') }}#individual">Clear</a>
            </div>
          </form>

          {% if student_user %}
            <div style="margin-top:12px;"><h4>{{ student_user.name or student_user.email }}</h4></div>
          {% endif %}

          {% if student_stats %}
            <div class="stats-grid" style="margin-top:10px;">
              <div class="card"><strong>Most common mood:</strong> {{ student_stats.most_common_mood or '—' }}</div>
              <div class="card"><strong>Best hour:</strong> {{ student_stats.best_hour if student_stats.best_hour is not none else '—' }}</div>
              <div class="card"><strong>Best month:</strong> {{ student_stats.best_month if student_stats.best_month is not none else '—' }}</div>
            </div>
            <div class="axes-layout" style="margin-top:8px;">
              <div class="axis-y" aria-hidden="true">
                <svg class="axis-y-svg" viewBox="0 0 16 100" preserveAspectRatio="none" focusable="false" aria-hidden="true">
                  <defs>
                    <marker id="arrowhead-y" markerWidth="6" markerHeight="6" refX="3" refY="3" orient="auto" markerUnits="strokeWidth">
                      <path d="M0,0 L6,3 L0,6 z" fill="currentColor"></path>
                    </marker>
                  </defs>
                  <line x1="8" y1="6" x2="8" y2="94" stroke="currentColor" stroke-width="2" marker-start="url(#arrowhead-y)" marker-end="url(#arrowhead-y)"></line>
                </svg>
                <div class="axis-label axis-label-y">Energy</div>
              </div>
              <div class="grid-wrapper">
                <div class="grid">
                  {% set maxc = student_stats.max_count or 0 %}
                  {% for y in range(size) %}
                    <div class="row">
                      {% for x in range(size) %}
                        {% set c = student_stats.heatmap[y][x] %}
                        {% set t = (c / maxc) if maxc else 0 %}
                        {% set label = grid[y][x] %}
                        <div class="cell" data-x="{{ x }}" data-y="{{ y }}" data-intensity="{{ t }}">
                          <span class="cell-label">{{ label }}</span>
                          {% if c %}<span class="heat-count">{{ c }}</span>{% endif %}
                        </div>
                      {% endfor %}
                    </div>
                  {% endfor %}
                </div>
              </div>
              <div class="axis-x" aria-hidden="true">
                <svg class="axis-x-svg" viewBox="0 0 100 16" preserveAspectRatio="none" focusable="false" aria-hidden="true">
                  <defs>
                    <marker id="arrowhead-x" markerWidth="6" markerHeight="6" refX="3" refY="3" orient="auto" markerUnits="strokeWidth">
                      <path d="M0,0 L6,3 L0,6 z" fill="currentColor"></path>
                    </marker>
                  </defs>
                  <line x1="6" y1="8" x2="94" y2="8" stroke="currentColor" stroke-width="2" marker-start="url(#arrowhead-x)" marker-end="url(#arrowhead-x)"></line>
                </svg>
                <div class="axis-label axis-label-x">Pleasantness</div>
              </div>
            </div>
          {% endif %}
        </div>
      </section>
    </div>

    <script>
      // Tabs behavior, manage tab actions, and student search filtering
      (function(){
        // Ensure axis arrowheads point outward on both ends
        try { document.querySelectorAll('marker#arrowhead-x, marker#arrowhead-y').forEach(m => m.setAttribute('orient','auto-start-reverse')); } catch {}
        const tabBtns = Array.from(document.querySelectorAll('.tab-btn'));
        const panels = Array.from(document.querySelectorAll('.tab-panel'));
        function activate(tab){
          for (const b of tabBtns){ b.classList.toggle('active', b.dataset.tab===tab); b.setAttribute('aria-selected', String(b.dataset.tab===tab)); }
          for (const p of panels){ p.classList.toggle('active', p.dataset.tab===tab); }
          if (location.hash !== '#' + tab) history.replaceState(null, '', '#' + tab);
          try { localStorage.setItem('teacher_tab', tab); } catch {}
        }
        for (const b of tabBtns){ b.addEventListener('click', ()=> activate(b.dataset.tab)); }
        let initial = (location.hash||'').replace('#','') || (localStorage.getItem('teacher_tab')||'group');
        if (!['group','manage','individual'].includes(initial)) initial = 'group';
        activate(initial);

        // Manage tab: group selection reload to show members
        const manageSelect = document.getElementById('manage_group');
        if (manageSelect){
          manageSelect.addEventListener('change', function(){
            const gid = this.value;
            // keep on manage tab after reload
            window.location.href = '/dashboard?group_id=' + encodeURIComponent(gid) + '#manage';
          });
        }

        // Manage tab: existing student dropdown populates email field
        const studentSelect2 = document.getElementById('student_select2');
        if (studentSelect2){
          studentSelect2.addEventListener('change', function(){
            const emailInput = document.getElementById('student_email2');
            if (emailInput) emailInput.value = this.value || '';
          });
        }

        // Manage tab: intercept Add Member form to use fetch
        const addForm = document.getElementById('addMemberForm2');
        if (addForm){
          addForm.addEventListener('submit', async function(ev){
            ev.preventDefault();
            const fd = new FormData(addForm);
            const gid = (document.getElementById('manage_group')||{}).value || '';
            const email = (document.getElementById('student_email2')||{}).value || '';
            if (!gid || !email){ return; }
            try {
              const resp = await fetch(`/groups/${encodeURIComponent(gid)}/members`, {
                method: 'POST',
                headers: {
                  'Accept': 'application/json',
                  'X-Requested-With': 'XMLHttpRequest',
                  'Content-Type': 'application/x-www-form-urlencoded; charset=UTF-8'
                },
                body: new URLSearchParams({ email })
              });
              const json = await resp.json().catch(()=>({}));
              if (resp.ok && json.ok){
                // force reload to show updated member list (cache-busted)
                window.location.assign('/dashboard?group_id=' + encodeURIComponent(gid) + '&r=' + Date.now() + '#manage');
              } else {
                alert('Failed to add member' + (json.detail ? (': ' + json.detail) : ''));
              }
            } catch (e){
              alert('Network error while adding member');
            }
          });
        }

        // Manage tab: remove member buttons
        document.addEventListener('click', async function(ev){
          const btn = ev.target.closest('.remove-member');
          if (!btn) return;
          const gid = btn.getAttribute('data-group-id');
          const sid = btn.getAttribute('data-student-id');
          if (!gid || !sid) return;
          if (!confirm('Remove this user from the group?')) return;
          try {
            const resp = await fetch(`/groups/${encodeURIComponent(gid)}/members/${encodeURIComponent(sid)}/remove`, { 
              method: 'POST',
              headers: {
                'Accept': 'application/json',
                'X-Requested-With': 'XMLHttpRequest'
              }
            });
            const json = await resp.json().catch(()=>({}));
            if (resp.ok && json.ok){
              window.location.assign('/dashboard?group_id=' + encodeURIComponent(gid) + '&r=' + Date.now() + '#manage');
            } else {
              alert('Failed to remove member' + (json.detail ? (': ' + json.detail) : ''));
            }
          } catch (e){
            alert('Network error while removing member');
          }
        });

        // Manage tab: delete group
        const delBtn = document.getElementById('deleteGroupBtn');
        if (delBtn){
          delBtn.addEventListener('click', async function(){
            const gid = this.getAttribute('data-group-id');
            if (!gid) return;
            if (!confirm('Delete this group and remove all its memberships?')) return;
            try {
              const resp = await fetch(`/groups/${encodeURIComponent(gid)}/delete`, { 
                method: 'POST',
                headers: {
                  'Accept': 'application/json',
                  'X-Requested-With': 'XMLHttpRequest'
                }
              });
              const json = await resp.json().catch(()=>({}));
              if (resp.ok && json.ok){
                window.location.assign('/dashboard?r=' + Date.now() + '#manage');
              } else {
                alert('Failed to delete group' + (json.detail ? (': ' + json.detail) : ''));
              }
            } catch (e){
              alert('Network error while deleting group');
            }
          });
        }

        // Individual search filter
        const search = document.getElementById('userSearch');
        const select = document.getElementById('userSelect');
        if (search && select){
          const all = Array.from(select.querySelectorAll('option')).map(o => ({ value:o.value, text:o.textContent }));
          function applyFilter(){
            const q = (search.value||'').toLowerCase().trim();
            const filtered = q ? all.filter(o => o.text.toLowerCase().includes(q)) : all;
            const current = select.value;
            select.innerHTML = '';
            for (const o of filtered){
              const opt = document.createElement('option');
              opt.value = o.value; opt.textContent = o.text; select.appendChild(opt);
            }
            if (filtered.some(o => o.value===current)) select.value = current; else select.value = '';
          }
          search.addEventListener('input', applyFilter);
        }
      })();
    </script>

    <div class="columns">
      <div class="card">
        <form class="filter-form" method="get" action="{{ url_for('dashboard') }}">
          <div class="filters">
            <div>
              <label for="group_id">Group</label>
              <select id="group_id" name="group_id">
                <option value="">All students (in selected group if chosen)</option>
                {% for g in groups %}
                  <option value="{{ g.id }}" {% if current_group_id and g.id == current_group_id %}selected{% endif %}>{{ g.name }}</option>
                {% endfor %}
              </select>
            </div>
            <div>
              <label for="date_from">From date</label>
              <input type="date" id="date_from" name="date_from" value="{{ filters.date_from or '' }}" />
            </div>
            <div>
              <label for="date_to">To date</label>
              <input type="date" id="date_to" name="date_to" value="{{ filters.date_to or '' }}" />
            </div>
            <div style="grid-column: span 4;">
              <details {% if filters.time_from or filters.time_to %}open{% endif %}>
                <summary>Time options (UTC)</summary>
                <div style="display:grid; grid-template-columns: repeat(2, minmax(140px, 1fr)); gap:8px; margin-top:8px;">
                  <div>
                    <label for="time_from">From time (UTC)</label>
                    <input type="time" id="time_from" name="time_from" value="{{ filters.time_from or '' }}" />
                  </div>
                  <div>
                    <label for="time_to">To time (UTC)</label>
                    <input type="time" id="time_to" name="time_to" value="{{ filters.time_to or '' }}" />
                  </div>
                </div>
              </details>
            </div>
            <div style="grid-column: span 4; display:flex; gap:8px;">
              <button class="btn" type="submit">Apply filters</button>
              <a class="btn" href="{{ url_for('dashboard') }}">Reset</a>
            </div>
          </div>
        </form>

        <div class="stats-grid">
          <div class="card"><strong>Most common mood:</strong> {{ stats.most_common_mood or '—' }}</div>
          <div class="card"><strong>Best hour (UTC):</strong> {{ stats.best_hour if stats.best_hour is not none else '—' }}</div>
          <div class="card"><strong>Worst hour (UTC):</strong> {{ stats.worst_hour if stats.worst_hour is not none else '—' }}</div>
          <div class="card"><strong>Best month:</strong> {{ stats.best_month if stats.best_month is not none else '—' }}</div>
          <div class="card"><strong>Worst month:</strong> {{ stats.worst_month if stats.worst_month is not none else '—' }}</div>
          <div class="card"><strong>Best day of week (0=Mon):</strong> {{ stats.best_dow if stats.best_dow is not none else '—' }}</div>
          <div class="card"><strong>Worst day of week (0=Mon):</strong> {{ stats.worst_dow if stats.worst_dow is not none else '—' }}</div>
        </div>

        <div class="card" style="margin-top:12px;">
          <h3 style="margin-bottom:10px">Group heatmap</h3>
          <div class="axes-layout">
            <div class="axis-y" aria-hidden="true">
              <svg class="axis-y-svg" viewBox="0 0 16 100" preserveAspectRatio="none" focusable="false" aria-hidden="true">
                <defs>
                  <marker id="arrowhead-y" markerWidth="6" markerHeight="6" refX="3" refY="3" orient="auto" markerUnits="strokeWidth">
                    <path d="M0,0 L6,3 L0,6 z" fill="currentColor"></path>
                  </marker>
                </defs>
                <line x1="8" y1="6" x2="8" y2="94" stroke="currentColor" stroke-width="2" marker-start="url(#arrowhead-y)" marker-end="url(#arrowhead-y)"></line>
              </svg>
              <div class="axis-label axis-label-y">Energy</div>
            </div>
            <div class="grid-wrapper">
              <div class="grid" role="grid" aria-label="Heatmap grid"
                   data-date-from="{{ filters.date_from or '' }}"
                   data-date-to="{{ filters.date_to or '' }}"
                   data-time-from="{{ filters.time_from or '' }}"
                   data-time-to="{{ filters.time_to or '' }}"
                   data-group-id="{{ current_group_id or '' }}">
                {% set maxc = stats.max_count or 0 %}
                {% for y in range(size) %}
                  <div class="row" role="row">
                    {% for x in range(size) %}
                      {% set c = stats.heatmap[y][x] %}
                      {% set t = (c / maxc) if maxc else 0 %}
                      {% set label = grid[y][x] %}
                      <div class="cell" data-x="{{ x }}" data-y="{{ y }}" data-intensity="{{ t }}" data-count="{{ c }}" data-cell-label="{{ label }}">
                        <span class="cell-label">{{ label }}</span>
                        {% if c %}<span class="heat-count">{{ c }}</span>{% endif %}
                      </div>
                    {% endfor %}
                  </div>
                {% endfor %}
              </div>
            </div>
            <div class="axis-x" aria-hidden="true">
              <svg class="axis-x-svg" viewBox="0 0 100 16" preserveAspectRatio="none" focusable="false" aria-hidden="true">
                <defs>
                  <marker id="arrowhead-x" markerWidth="6" markerHeight="6" refX="3" refY="3" orient="auto" markerUnits="strokeWidth">
                    <path d="M0,0 L6,3 L0,6 z" fill="currentColor"></path>
                  </marker>
                </defs>
                <line x1="6" y1="8" x2="94" y2="8" stroke="currentColor" stroke-width="2" marker-start="url(#arrowhead-x)" marker-end="url(#arrowhead-x)"></line>
              </svg>
              <div class="axis-label axis-label-x">Pleasantness</div>
            </div>
          </div>
        </div>
      </div>

      <div>
        <div class="card" style="margin-bottom:12px;">
          <details id="createGroupDetailsLegacy">
            <summary>Create New Group</summary>
            <form method="post" action="{{ url_for('groups_view') }}" style="display:flex; gap:8px; margin-top:8px;">
              <input type="text" name="name" placeholder="Group name" required />
              <button class="btn" type="submit">Create</button>
            </form>
          </details>
        </div>

        <div class="card">
          <h3>Manage members</h3>
          {% if groups %}
            <p style="margin:6px 0 8px;">Add student by email to selected group:</p>
            <form id="addMemberForm" method="post" action="{{ url_for('add_member', group_id=(current_group_id or groups[0].id)) }}" style="display:flex; gap:8px;">
              <input type="email" name="email" placeholder="student@email" required />
              <button class="btn" type="submit">Add</button>
            </form>
            <p style="opacity:.7; font-size:12px; margin-top:8px;">Tip: Select a group at left first to target additions.</p>
          {% else %}
            <p>No groups yet.</p>
          {% endif %}
        </div>

        <div class="card" style="margin-top:12px;">
          <details>
            <summary>View individual student</summary>
            <form method="get" action="{{ url_for('dashboard') }}" style="display:grid; grid-template-columns: 1fr; gap:8px; margin-top:8px;">
              <input type="hidden" name="group_id" value="{{ current_group_id or '' }}" />
              <label>Email to view (must exist):</label>
              <input type="text" name="student_email" placeholder="student@email" />
              <div style="display:flex; gap:8px;">
                <button class="btn" type="submit">Load</button>
                <a class="btn" href="{{ url_for('dashboard', group_id=current_group_id) }}">Clear</a>
              </div>
            </form>
            {% if request.args.get('student_email') %}
              {% set s = (all_students|selectattr('email','equalto', request.args.get('student_email'))|list|first) %}
              {% if s %}
                <div style="margin-top:12px;">
                  <h4>{{ s.name or s.email }}</h4>
                </div>
              {% else %}
                <p style="color:#f99">Student not found.</p>
              {% endif %}
            {% endif %}
            {% if student_stats %}
              <div class="stats-grid" style="margin-top:10px;">
                <div class="card"><strong>Most common mood:</strong> {{ student_stats.most_common_mood or '—' }}</div>
                <div class="card"><strong>Best hour:</strong> {{ student_stats.best_hour if student_stats.best_hour is not none else '—' }}</div>
                <div class="card"><strong>Best month:</strong> {{ student_stats.best_month if student_stats.best_month is not none else '—' }}</div>
              </div>
              <div class="axes-layout" style="margin-top:8px;">
                <div class="axis-y" aria-hidden="true">
                  <svg class="axis-y-svg" viewBox="0 0 16 100" preserveAspectRatio="none" focusable="false" aria-hidden="true">
                    <defs>
                      <marker id="arrowhead-y" markerWidth="6" markerHeight="6" refX="3" refY="3" orient="auto" markerUnits="strokeWidth">
                        <path d="M0,0 L6,3 L0,6 z" fill="currentColor"></path>
                      </marker>
                    </defs>
                    <line x1="8" y1="6" x2="8" y2="94" stroke="currentColor" stroke-width="2" marker-start="url(#arrowhead-y)" marker-end="url(#arrowhead-y)"></line>
                  </svg>
                  <div class="axis-label axis-label-y">Energy</div>
                </div>
                <div class="grid-wrapper">
                  <div class="grid"
                       data-avg-tx="{{ student_stats.avg_tx if student_stats.avg_tx is not none else '' }}"
                       data-avg-ty="{{ student_stats.avg_ty if student_stats.avg_ty is not none else '' }}"
                       data-date-from="{{ filters.date_from or '' }}"
                       data-date-to="{{ filters.date_to or '' }}"
                       data-time-from="{{ filters.time_from or '' }}"
                       data-time-to="{{ filters.time_to or '' }}"
                       data-student-id="{{ student_user.id if student_user else '' }}">
                    {% set maxc = student_stats.max_count or 0 %}
                    {% for y in range(size) %}
                      <div class="row">
                        {% for x in range(size) %}
                          {% set c = student_stats.heatmap[y][x] %}
                          {% set t = (c / maxc) if maxc else 0 %}
                          {% set label = grid[y][x] %}
                          <div class="cell" data-x="{{ x }}" data-y="{{ y }}" data-intensity="{{ t }}" data-count="{{ c }}" data-cell-label="{{ label }}">
                            <span class="cell-label">{{ label }}</span>
                            {% if c %}<span class="heat-count">{{ c }}</span>{% endif %}
                          </div>
                        {% endfor %}
                      </div>
                    {% endfor %}
                  </div>
                </div>
                <div class="axis-x" aria-hidden="true">
                  <svg class="axis-x-svg" viewBox="0 0 100 16" preserveAspectRatio="none" focusable="false" aria-hidden="true">
                    <defs>
                      <marker id="arrowhead-x" markerWidth="6" markerHeight="6" refX="3" refY="3" orient="auto" markerUnits="strokeWidth">
                        <path d="M0,0 L6,3 L0,6 z" fill="currentColor"></path>
                      </marker>
                    </defs>
                    <line x1="6" y1="8" x2="94" y2="8" stroke="currentColor" stroke-width="2" marker-start="url(#arrowhead-x)" marker-end="url(#arrowhead-x)"></line>
                  </svg>
                  <div class="axis-label axis-label-x">Pleasantness</div>
                </div>
              </div>
              {% if student_stats and student_stats.avg_x is not none %}
              <div class="avg-legend" aria-live="polite">
                {% set quad = student_stats.avg_quadrant or '' %}
                {% if quad == 'red' %}{% set dot_class = 'q-red' %}
                {% elif quad == 'yellow' %}{% set dot_class = 'q-yellow' %}
                {% elif quad == 'blue' %}{% set dot_class = 'q-blue' %}
                {% else %}{% set dot_class = 'q-green' %}{% endif %}
                <span class="dot {{ dot_class }}"></span>
                <span class="label">Overall average anchor: <strong>{{ student_stats.avg_quadrant_label }}</strong>{% if student_stats.avg_meaning %} — {{ student_stats.avg_meaning }}{% endif %}</span>
              </div>
              {% endif %}
            {% endif %}
          </details>
        </div>
      </div>
    </div>
  </div>
  <script>
    (function() {
      const size = Number('{{ size|tojson }}');
      function lerp(a, b, t) { return a + (b - a) * t; }
      function clamp01(x) { return Math.max(0, Math.min(1, x)); }
      function mix(c0, c1, t){
        return [
          Math.round(lerp(c0[0], c1[0], t)),
          Math.round(lerp(c0[1], c1[1], t)),
          Math.round(lerp(c0[2], c1[2], t))
        ];
      }
      function rgb(c){ return `rgb(${c[0]}, ${c[1]}, ${c[2]})`; }
      const C_TL = [224, 56, 56];
      const C_TR = [246, 223, 95];
      const C_BL = [70, 112, 214];
      const C_BR = [74, 201, 129];
      // Quadrant-based color with sharp midline boundaries, gradient within quadrants
      function quadrantColor(tX, tY) {
        const left = tX <= 0.5;
        const top = tY <= 0.5;
        const qX = left ? (tX / 0.5) : ((tX - 0.5) / 0.5);
        const qY = top ? (tY / 0.5) : ((tY - 0.5) / 0.5);
        if (top && left) {
          const anchor0 = C_TL;
          const anchor1 = [235, 120, 80];
          const horiz = [220, 70, 70];
          const mixH = [
            Math.round(lerp(anchor0[0], horiz[0], qX)),
            Math.round(lerp(anchor0[1], horiz[1], qX)),
            Math.round(lerp(anchor0[2], horiz[2], qX)),
          ];
          return [
            Math.round(lerp(mixH[0], anchor1[0], 0.25 * Math.max(qX, qY))),
            Math.round(lerp(mixH[1], anchor1[1], 0.25 * Math.max(qX, qY))),
            Math.round(lerp(mixH[2], anchor1[2], 0.25 * Math.max(qX, qY))),
          ];
        }
        if (top && !left) {
          const anchor0 = C_TR;
          const anchor1 = [255, 200, 80];
          const horiz = [248, 230, 120];
          const mixH = [
            Math.round(lerp(anchor0[0], horiz[0], qX)),
            Math.round(lerp(anchor0[1], horiz[1], qX)),
            Math.round(lerp(anchor0[2], horiz[2], qX)),
          ];
          return [
            Math.round(lerp(mixH[0], anchor1[0], 0.25 * Math.max(qX, qY))),
            Math.round(lerp(mixH[1], anchor1[1], 0.25 * Math.max(qX, qY))),
            Math.round(lerp(mixH[2], anchor1[2], 0.25 * Math.max(qX, qY))),
          ];
        }
        if (!top && left) {
          const anchor0 = C_BL;
          const anchor1 = [110, 150, 230];
          const horiz = [80, 130, 220];
          const mixH = [
            Math.round(lerp(anchor0[0], horiz[0], qX)),
            Math.round(lerp(anchor0[1], horiz[1], qX)),
            Math.round(lerp(anchor0[2], horiz[2], qX)),
          ];
          return [
            Math.round(lerp(mixH[0], anchor1[0], 0.25 * Math.max(qX, qY))),
            Math.round(lerp(mixH[1], anchor1[1], 0.25 * Math.max(qX, qY))),
            Math.round(lerp(mixH[2], anchor1[2], 0.25 * Math.max(qX, qY))),
          ];
        }
        // bottom-right
        const anchor0 = C_BR;
        const anchor1 = [120, 220, 150];
        const horiz = [90, 210, 140];
        const mixH = [
          Math.round(lerp(anchor0[0], horiz[0], qX)),
          Math.round(lerp(anchor0[1], horiz[1], qX)),
          Math.round(lerp(anchor0[2], horiz[2], qX)),
        ];
        return [
          Math.round(lerp(mixH[0], anchor1[0], 0.25 * Math.max(qX, qY))),
          Math.round(lerp(mixH[1], anchor1[1], 0.25 * Math.max(qX, qY))),
          Math.round(lerp(mixH[2], anchor1[2], 0.25 * Math.max(qX, qY))),
        ];
      }
      const NEUTRAL = [34, 36, 43];
      function applyHeatColors(root) {
        const cells = root.querySelectorAll('.cell[data-x][data-y]');
        for (const cell of cells) {
          const x = parseInt(cell.dataset.x, 10) || 0;
          const y = parseInt(cell.dataset.y, 10) || 0;
          const t = Math.max(0, Math.min(1, parseFloat(cell.dataset.intensity || '0')));
          const tX = size > 1 ? x / (size - 1) : 0;
          const tY = size > 1 ? y / (size - 1) : 0;
          const base = quadrantColor(tX, tY);
          const strength = 0.25 + 0.75 * t; // ensure faint color even at low intensity
          const mixed = mix(NEUTRAL, base, strength);
          const bg = `linear-gradient(140deg, ${rgb(mixed)}, rgba(0,0,0,0.15))`;
          cell.style.background = bg;
          cell.style.filter = `saturate(${0.7 + 0.8 * t}) brightness(${0.9 + 0.2 * t})`;
        }
      }
      function addAvgGlow(root) {
        const txStr = root.dataset.avgTx;
        const tyStr = root.dataset.avgTy;
        if (!txStr || !tyStr) return;
        const tx = parseFloat(txStr);
        const ty = parseFloat(tyStr);
        if (!isFinite(tx) || !isFinite(ty)) return;
        const [r,g,b] = quadrantColor(tx, ty);
        const x = Math.round(tx * 10000) / 100;
        const y = Math.round(ty * 10000) / 100;
        const overlay = document.createElement('div');
        overlay.className = 'avg-glow';
        overlay.style.background = `radial-gradient(circle at ${x}% ${y}%, rgba(${r},${g},${b},0.22) 0%, rgba(${r},${g},${b},0.12) 22%, rgba(${r},${g},${b},0.06) 38%, transparent 62%)`;
        root.appendChild(overlay);
      }
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', () => {
          for (const grid of document.querySelectorAll('.grid')) { applyHeatColors(grid); addAvgGlow(grid); }
        });
      } else {
        for (const grid of document.querySelectorAll('.grid')) { applyHeatColors(grid); addAvgGlow(grid); }
      }
    })();
  </script>
  <script>
    (function(){
      function ensureModalRoot(){
        let root = document.getElementById('neon-modal-root');
        if (!root){ root = document.createElement('div'); root.id = 'neon-modal-root'; root.className = 'neon-modal-root'; document.body.appendChild(root); }
        return root;
      }
      function closeModal(wrap){ if (wrap && wrap.parentNode) wrap.parentNode.removeChild(wrap); }
      function openDetailsModal(cell, data){
        const root = ensureModalRoot();
        const wrap = document.createElement('div');
        wrap.className = 'neon-modal';
        wrap.setAttribute('role','dialog'); wrap.setAttribute('aria-modal','true');
        const backdrop = document.createElement('div'); backdrop.className = 'neon-modal__backdrop';
        const panel = document.createElement('div'); panel.className = 'neon-modal__panel';
        panel.style.maxWidth = '920px'; panel.style.width = '92vw'; panel.style.maxHeight = '82vh'; panel.style.overflow = 'hidden';
        panel.innerHTML = `
          <div class="neon-modal__glow" aria-hidden="true"></div>
          <div style="display:flex; align-items:center; justify-content:space-between; gap:8px; margin-bottom:8px;">
            <div>
              <div class="neon-modal__title">${(data.cell.label || 'Selected cell')} — ${data.cell.count} entr${data.cell.count===1?'y':'ies'}</div>
              <div class="neon-modal__message" style="opacity:.85;">Pleasantness ${data.cell.x+1}, Energy ${data.cell.y+1}</div>
            </div>
            <button type="button" aria-label="Close" class="btn" id="hm-close-btn">Close</button>
          </div>
          <div style="border:1px solid rgba(255,255,255,0.08); border-radius:12px; padding:10px; background:#121418; box-shadow: inset 0 1px 0 rgba(255,255,255,0.04);">
            ${data.entries.length ? '<ul id="hm-list" style="list-style:none; margin:0; padding:0; display:grid; gap:8px; max-height:60vh; overflow:auto;"></ul>' : '<div style="padding:16px; text-align:center; color:#cfe7ff;">No entries</div>'}
          </div>`;
        wrap.appendChild(backdrop); wrap.appendChild(panel); ensureModalRoot().appendChild(wrap);
        function onEsc(e){ if (e.key === 'Escape'){ e.preventDefault(); cleanup(); } }
        function cleanup(){ document.removeEventListener('keydown', onEsc); closeModal(wrap); }
        backdrop.addEventListener('click', cleanup);
        const closeBtn = panel.querySelector('#hm-close-btn'); if (closeBtn) closeBtn.addEventListener('click', cleanup);
        document.addEventListener('keydown', onEsc);
        const list = panel.querySelector('#hm-list');
        if (list){
          const fmt = new Intl.DateTimeFormat(undefined, { dateStyle: 'medium', timeStyle: 'short' });
          for (const e of data.entries){
            const li = document.createElement('li');
            li.style.padding = '10px 12px';
            li.style.border = '1px solid rgba(255,255,255,0.06)';
            li.style.borderRadius = '10px';
            li.style.background = '#0f1217';
            const d = e.chosen_at ? new Date(e.chosen_at) : null;
            const when = d ? fmt.format(d) : (e.created_at ? fmt.format(new Date(e.created_at)) : 'Unknown time');
            const mood = e.label ? `<span style="opacity:.9"> — ${e.label}</span>` : '';
            li.innerHTML = `<div><strong>${when}</strong>${mood}</div>`;
            list.appendChild(li);
          }
        }
      }
      function attachCellHandlers(){
        const grids = document.querySelectorAll('.grid');
        for (const grid of grids){
          grid.addEventListener('click', async (ev) => {
            const cell = ev.target.closest('.cell'); if (!cell || !grid.contains(cell)) return;
            const count = parseInt(cell.dataset.count || '0', 10); if (!count) return;
            const x = parseInt(cell.dataset.x, 10); const y = parseInt(cell.dataset.y, 10);
            const qs = new URLSearchParams();
            qs.set('x', String(x)); qs.set('y', String(y));
            const df = grid.dataset.dateFrom; const dt = grid.dataset.dateTo; const tf = grid.dataset.timeFrom; const tt = grid.dataset.timeTo;
            if (df) qs.set('date_from', df); if (dt) qs.set('date_to', dt); if (tf) qs.set('time_from', tf); if (tt) qs.set('time_to', tt);
            const gid = grid.dataset.groupId; if (gid) qs.set('group_id', gid);
            const sid = grid.dataset.studentId; if (sid) qs.set('student_id', sid);
            try {
              const res = await fetch(`/api/cell-entries?${qs.toString()}`);
              const data = await res.json();
              if (!data.ok) { console.warn('Failed to load entries', data); return; }
              openDetailsModal(cell, data);
            } catch (e) { console.error(e); }
          });
        }
      }
      if (document.readyState === 'loading') { document.addEventListener('DOMContentLoaded', attachCellHandlers); } else { attachCellHandlers(); }
    })();
  </script>
</body>
</html>
