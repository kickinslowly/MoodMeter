<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Student Dashboard</title>
  <link rel="stylesheet" href="https://unpkg.com/modern-css-reset/dist/reset.min.css">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}" />
  <style>
    .dash-container { max-width: 1100px; margin: 0 auto; padding: 16px; }
    .dash-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 16px; }
    .filters { display: grid; grid-template-columns: repeat(4, minmax(140px, 1fr)); gap: 8px; margin: 12px 0 20px; }
    .stats { display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; margin-bottom: 20px; }
    .card { background: #1f2227; color: #e8eaeF; padding: 12px; border-radius: 10px; box-shadow: 0 6px 22px rgba(0,0,0,0.45), inset 0 1px 0 rgba(255,255,255,0.06); }
    .grid .cell { position: relative; }
    .heat-count { position: absolute; right: 6px; bottom: 4px; font-size: 12px; color: #fff; text-shadow: 0 1px 2px rgba(0,0,0,0.8); }
    .header-actions { display: flex; align-items: center; gap: 8px; }
    .link-btn { color: #72d5ff; text-decoration: none; border: 1px solid #3a3f47; padding: 6px 10px; border-radius: 8px; }
    .filter-form label { font-size: 12px; opacity: .8; display:block; margin-bottom:4px; }
    .filter-form input { width: 100%; padding: 6px 8px; border-radius: 8px; border: 1px solid #3a3f47; background: #121418; color: #e8eaef; }
    .filter-actions { grid-column: span 4; display: flex; gap: 8px; }
    .btn { background: #2f3540; color: #e8eaef; border: 1px solid #3a3f47; padding: 8px 12px; border-radius: 8px; cursor: pointer; }

    /* Collapsible filter styles */
    .filter-collapsible { border: 1px solid #333842; border-radius: 10px; background: #1b1f25; padding: 8px 10px; }
    .filter-collapsible > summary { list-style: none; cursor: pointer; font-weight: 600; color: #e8eaef; outline: none; }
    .filter-collapsible > summary::-webkit-details-marker { display: none; }
    .filter-collapsible[open] { padding-bottom: 10px; }
    .filter-collapsible .filters { margin-top: 10px; }

    /* Stats grouping sections */
    .stat-sections { display: grid; gap: 14px; margin-bottom: 20px; }
    .stat-section { border: 1px solid #333842; border-radius: 12px; padding: 10px; background: #1b1f25; }
    .stat-section.energy-theme { border-color: rgba(74, 201, 129, 0.45); background: linear-gradient(180deg, rgba(74,201,129,0.08), transparent 60%) #1b1f25; }
    .stat-section.pleasant-theme { border-color: rgba(246, 223, 95, 0.5); background: linear-gradient(180deg, rgba(246,223,95,0.10), transparent 60%) #1b1f25; }
    .section-title { margin: 0 0 8px; font-size: 16px; opacity: .95; }
    .stat-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
    .stat-stack { display: grid; gap: 8px; }
    @media (max-width: 900px) { .stat-grid { grid-template-columns: repeat(2, 1fr); } }
    @media (max-width: 580px) { .stat-grid { grid-template-columns: 1fr; } }
    /* Hide footer on dashboard pages */
    .footer { display: none !important; }
  </style>
</head>
<body>
  <div class="dash-container">
    <div class="dash-header">
      <h1>Student Dashboard</h1>
      <div class="header-actions">
        <a class="link-btn" href="{{ url_for('index') }}">Mood Meter</a>
        <form method="post" action="{{ url_for('logout_view') }}">
          <button type="submit" class="btn">Logout</button>
        </form>
      </div>
    </div>


    <div class="stats">
      <div class="card"><strong>Most common mood:</strong> {{ stats.most_common_mood or '—' }}</div>
    </div>

    {% set month_names = ['', 'January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'] %}
    {% set day_names = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'] %}
    {% macro hour12(h) -%}
      {%- if h is not none -%}
        {{ (h % 12) if (h % 12) else 12 }}:00 {{ 'PM' if h >= 12 else 'AM' }}
      {%- else -%}
        —
      {%- endif -%}
    {%- endmacro %}

    <div class="stat-sections">
      <section class="stat-section energy-theme" aria-labelledby="energy-stats-title">
        <h3 id="energy-stats-title" class="section-title">Energy stats</h3>
        <div class="stat-grid">
          <div class="stat-stack">
            <div class="card"><strong>Highest energy month:</strong> {{ month_names[stats.month_high_energy] if stats.month_high_energy is not none else '—' }}</div>
            <div class="card"><strong>Lowest energy month:</strong> {{ month_names[stats.month_low_energy] if stats.month_low_energy is not none else '—' }}</div>
          </div>
          <div class="stat-stack">
            <div class="card"><strong>Highest energy day:</strong> {{ day_names[stats.day_high_energy] if stats.day_high_energy is not none else '—' }}</div>
            <div class="card"><strong>Lowest energy day:</strong> {{ day_names[stats.day_low_energy] if stats.day_low_energy is not none else '—' }}</div>
          </div>
          <div class="stat-stack">
            <div class="card"><strong>Highest energy hour:</strong> {{ hour12(stats.time_high_energy) }}</div>
            <div class="card"><strong>Lowest energy hour:</strong> {{ hour12(stats.time_low_energy) }}</div>
          </div>
        </div>
      </section>

      <section class="stat-section pleasant-theme" aria-labelledby="pleasant-stats-title">
        <h3 id="pleasant-stats-title" class="section-title">Pleasantness stats</h3>
        <div class="stat-grid">
          <div class="stat-stack">
            <div class="card"><strong>Most pleasant month:</strong> {{ month_names[stats.month_most_pleasant] if stats.month_most_pleasant is not none else '—' }}</div>
            <div class="card"><strong>Least pleasant month:</strong> {{ month_names[stats.month_least_pleasant] if stats.month_least_pleasant is not none else '—' }}</div>
          </div>
          <div class="stat-stack">
            <div class="card"><strong>Most pleasant day:</strong> {{ day_names[stats.day_most_pleasant] if stats.day_most_pleasant is not none else '—' }}</div>
            <div class="card"><strong>Least pleasant day:</strong> {{ day_names[stats.day_least_pleasant] if stats.day_least_pleasant is not none else '—' }}</div>
          </div>
          <div class="stat-stack">
            <div class="card"><strong>Most pleasant hour:</strong> {{ hour12(stats.time_most_pleasant) }}</div>
            <div class="card"><strong>Least pleasant hour:</strong> {{ hour12(stats.time_least_pleasant) }}</div>
          </div>
        </div>
      </section>
    </div>

    <div class="card" style="margin-bottom:12px;">
      <h3 style="margin-bottom:8px;">Your Trend</h3>
      <pre class="info-pre" style="display:none; white-space: pre-wrap; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, 'Liberation Mono', monospace; font-size: 12px; line-height: 1.35; color:#d7dbea; background: #16191f; padding:10px; border-radius:8px; border:1px solid #2a2f38; max-height: 260px; overflow:auto;">
Energy
Enraged
Panicked
Stressed
Jittery
Shocked
Surprised
Upbeat
Festive
Exhilarated
Ecstatic
Livid
Furious
Frustrated
Tense
Stunned
Hyper
Cheerful
Excited
Inspired
Elated
Fuming
Frightened
Angry
Nervous
Restless
Energized
Lively
Happy
Optimistic
Enthusiastic
Anxious
Apprehensive
Worried
Irritated
Annoyed
Pleased
Focused
Motivated
Proud
Thrilled
Dreadful
Troubled
Concerned
Uneasy
Peeved
1
Pleasant
1
Joyful
Hopeful
Playful
Blissful
Disgusted
Glum
Dissapointed
Down
Apathetic
At Ease
Easygoing
Content
Loving
Fullfilled
Pessimistic
Morose
Disheartened
Discouraged
Bored
Chill
Secure
Satisfied
Grateful
Touched
Alienated
Miserable
Sad
Lonely
Tired
Relaxed
1
Restful
Calm
Blessed
Balanced
Despondent
Depressed
Sullen
Exhausted
Fatigued
Mellow
Thoughtful
Peaceful
Comfortable
Carefree
1
Despair
1
Hopeless
Desolate
Spent
Drained
Sleepy
Complacent
Tranquil
Cozy
Serene
1
Pleasantness
      </pre>
      {% if stats.avg_x is not none %}
      <div class="avg-legend" aria-live="polite" style="margin-top:8px; font-size: 39px; line-height: 1.2;">
        {% set quad = stats.avg_quadrant or '' %}
        {% if quad == 'red' %}{% set dot_class = 'q-red' %}
        {% elif quad == 'yellow' %}{% set dot_class = 'q-yellow' %}
        {% elif quad == 'blue' %}{% set dot_class = 'q-blue' %}
        {% else %}{% set dot_class = 'q-green' %}{% endif %}
        <span class="dot {{ dot_class }}" style="width:30px; height:30px;"></span>
        <span class="label">Overall: <strong>{{ stats.avg_quadrant_label }}</strong>{% if stats.avg_meaning %} — {{ stats.avg_meaning }}{% endif %}</span>
      </div>
      {% endif %}
    </div>

    <div class="card">
      <h3 style="margin-bottom:10px">Your heatmap</h3>
      <div class="axes-layout">
        <div class="axis-y" aria-hidden="true">
          <svg class="axis-y-svg" viewBox="0 0 16 100" preserveAspectRatio="none" focusable="false" aria-hidden="true">
            <defs>
              <marker id="arrowhead-y" markerWidth="6" markerHeight="6" refX="3" refY="3" orient="auto" markerUnits="strokeWidth">
                <path d="M0,0 L6,3 L0,6 z" fill="currentColor"></path>
              </marker>
            </defs>
            <line x1="8" y1="6" x2="8" y2="94" stroke="currentColor" stroke-width="2" marker-start="url(#arrowhead-y)" marker-end="url(#arrowhead-y)"></line>
          </svg>
          <div class="axis-label axis-label-y">Energy</div>
        </div>
        <div class="grid-wrapper">
          <div class="grid" role="grid" aria-label="Heatmap grid"
               data-avg-tx="{{ stats.avg_tx if stats.avg_tx is not none else '' }}"
               data-avg-ty="{{ stats.avg_ty if stats.avg_ty is not none else '' }}"
               data-scope="student">
            {% set maxc = stats.max_count or 0 %}
            {% for y in range(size) %}
              <div class="row" role="row">
                {% for x in range(size) %}
                  {% set c = stats.heatmap[y][x] %}
                  {% set t = (c / maxc) if maxc else 0 %}
                  {% set label = grid[y][x] %}
                  <div class="cell" data-x="{{ x }}" data-y="{{ y }}" data-intensity="{{ t }}" data-count="{{ c }}" data-cell-label="{{ label }}">
                    <span class="cell-label">{{ label }}</span>
                    {% if c %}<span class="heat-count">{{ c }}</span>{% endif %}
                  </div>
                {% endfor %}
              </div>
            {% endfor %}
          </div>
        </div>
        <div class="axis-x" aria-hidden="true">
          <svg class="axis-x-svg" viewBox="0 0 100 16" preserveAspectRatio="none" focusable="false" aria-hidden="true">
            <defs>
              <marker id="arrowhead-x" markerWidth="6" markerHeight="6" refX="3" refY="3" orient="auto" markerUnits="strokeWidth">
                <path d="M0,0 L6,3 L0,6 z" fill="currentColor"></path>
              </marker>
            </defs>
            <line x1="6" y1="8" x2="94" y2="8" stroke="currentColor" stroke-width="2" marker-start="url(#arrowhead-x)" marker-end="url(#arrowhead-x)"></line>
          </svg>
          <div class="axis-label axis-label-x">Pleasantness</div>
        </div>
      </div>
    </div>
  </div>
  <script>
    (function() {
      // Ensure axis arrowheads point outward on both ends
      try { document.querySelectorAll('marker#arrowhead-x, marker#arrowhead-y').forEach(m => m.setAttribute('orient','auto-start-reverse')); } catch {}
      const size = Number('{{ size|tojson }}');
      function lerp(a, b, t) { return a + (b - a) * t; }
      function clamp01(x) { return Math.max(0, Math.min(1, x)); }
      function mix(c0, c1, t){
        return [
          Math.round(lerp(c0[0], c1[0], t)),
          Math.round(lerp(c0[1], c1[1], t)),
          Math.round(lerp(c0[2], c1[2], t))
        ];
      }
      function rgb(c){ return `rgb(${c[0]}, ${c[1]}, ${c[2]})`; }
      const C_TL = [224, 56, 56];
      const C_TR = [246, 223, 95];
      const C_BL = [70, 112, 214];
      const C_BR = [74, 201, 129];
      // Quadrant-based color with sharp midline boundaries, gradient within quadrants
      function quadrantColor(tX, tY) {
        const left = tX <= 0.5;
        const top = tY <= 0.5;
        const qX = left ? (tX / 0.5) : ((tX - 0.5) / 0.5);
        const qY = top ? (tY / 0.5) : ((tY - 0.5) / 0.5);
        if (top && left) {
          const anchor0 = C_TL;
          const anchor1 = [235, 120, 80];
          const horiz = [220, 70, 70];
          const mixH = [
            Math.round(lerp(anchor0[0], horiz[0], qX)),
            Math.round(lerp(anchor0[1], horiz[1], qX)),
            Math.round(lerp(anchor0[2], horiz[2], qX)),
          ];
          return [
            Math.round(lerp(mixH[0], anchor1[0], 0.25 * Math.max(qX, qY))),
            Math.round(lerp(mixH[1], anchor1[1], 0.25 * Math.max(qX, qY))),
            Math.round(lerp(mixH[2], anchor1[2], 0.25 * Math.max(qX, qY))),
          ];
        }
        if (top && !left) {
          const anchor0 = C_TR;
          const anchor1 = [255, 200, 80];
          const horiz = [248, 230, 120];
          const mixH = [
            Math.round(lerp(anchor0[0], horiz[0], qX)),
            Math.round(lerp(anchor0[1], horiz[1], qX)),
            Math.round(lerp(anchor0[2], horiz[2], qX)),
          ];
          return [
            Math.round(lerp(mixH[0], anchor1[0], 0.25 * Math.max(qX, qY))),
            Math.round(lerp(mixH[1], anchor1[1], 0.25 * Math.max(qX, qY))),
            Math.round(lerp(mixH[2], anchor1[2], 0.25 * Math.max(qX, qY))),
          ];
        }
        if (!top && left) {
          const anchor0 = C_BL;
          const anchor1 = [110, 150, 230];
          const horiz = [80, 130, 220];
          const mixH = [
            Math.round(lerp(anchor0[0], horiz[0], qX)),
            Math.round(lerp(anchor0[1], horiz[1], qX)),
            Math.round(lerp(anchor0[2], horiz[2], qX)),
          ];
          return [
            Math.round(lerp(mixH[0], anchor1[0], 0.25 * Math.max(qX, qY))),
            Math.round(lerp(mixH[1], anchor1[1], 0.25 * Math.max(qX, qY))),
            Math.round(lerp(mixH[2], anchor1[2], 0.25 * Math.max(qX, qY))),
          ];
        }
        // bottom-right
        const anchor0 = C_BR;
        const anchor1 = [120, 220, 150];
        const horiz = [90, 210, 140];
        const mixH = [
          Math.round(lerp(anchor0[0], horiz[0], qX)),
          Math.round(lerp(anchor0[1], horiz[1], qX)),
          Math.round(lerp(anchor0[2], horiz[2], qX)),
        ];
        return [
          Math.round(lerp(mixH[0], anchor1[0], 0.25 * Math.max(qX, qY))),
          Math.round(lerp(mixH[1], anchor1[1], 0.25 * Math.max(qX, qY))),
          Math.round(lerp(mixH[2], anchor1[2], 0.25 * Math.max(qX, qY))),
        ];
      }
      const NEUTRAL = [34, 36, 43];
      function applyHeatColors(root) {
        const cells = root.querySelectorAll('.cell[data-x][data-y]');
        for (const cell of cells) {
          const x = parseInt(cell.dataset.x, 10) || 0;
          const y = parseInt(cell.dataset.y, 10) || 0;
          const t = Math.max(0, Math.min(1, parseFloat(cell.dataset.intensity || '0')));
          const tX = size > 1 ? x / (size - 1) : 0;
          const tY = size > 1 ? y / (size - 1) : 0;
          const base = quadrantColor(tX, tY);
          const strength = 0.25 + 0.75 * t; // ensure faint color even at low intensity
          const mixed = mix(NEUTRAL, base, strength);
          const bg = `linear-gradient(140deg, ${rgb(mixed)}, rgba(0,0,0,0.15))`;
          cell.style.background = bg;
          cell.style.filter = `saturate(${0.7 + 0.8 * t}) brightness(${0.9 + 0.2 * t})`;
        }
      }
      function addAvgGlow(root) {
        const txStr = root.dataset.avgTx;
        const tyStr = root.dataset.avgTy;
        if (!txStr || !tyStr) return;
        const tx = parseFloat(txStr);
        const ty = parseFloat(tyStr);
        if (!isFinite(tx) || !isFinite(ty)) return;
        const [r,g,b] = quadrantColor(tx, ty);
        const x = Math.round(tx * 10000) / 100; // keep 2 decimals
        const y = Math.round(ty * 10000) / 100;
        const overlay = document.createElement('div');
        overlay.className = 'avg-glow';
        overlay.style.background = `radial-gradient(circle at ${x}% ${y}%, rgba(${r},${g},${b},0.22) 0%, rgba(${r},${g},${b},0.12) 22%, rgba(${r},${g},${b},0.06) 38%, transparent 62%)`;
        root.appendChild(overlay);
      }
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', () => {
          for (const grid of document.querySelectorAll('.grid')) { applyHeatColors(grid); addAvgGlow(grid); }
        });
      } else {
        for (const grid of document.querySelectorAll('.grid')) { applyHeatColors(grid); addAvgGlow(grid); }
      }
    })();
  </script>
  <script>
    (function(){
      function ensureModalRoot(){
        let root = document.getElementById('neon-modal-root');
        if (!root){
          root = document.createElement('div');
          root.id = 'neon-modal-root';
          root.className = 'neon-modal-root';
          document.body.appendChild(root);
        }
        return root;
      }
      function closeModal(wrap){ if (wrap && wrap.parentNode) wrap.parentNode.removeChild(wrap); }
      function openDetailsModal(cell, data){
        const root = ensureModalRoot();
        const wrap = document.createElement('div');
        wrap.className = 'neon-modal';
        wrap.setAttribute('role','dialog');
        wrap.setAttribute('aria-modal','true');
        const backdrop = document.createElement('div');
        backdrop.className = 'neon-modal__backdrop';
        const panel = document.createElement('div');
        panel.className = 'neon-modal__panel';
        panel.style.maxWidth = '820px';
        panel.style.width = '92vw';
        panel.style.maxHeight = '82vh';
        panel.style.overflow = 'hidden';
        panel.innerHTML = `
          <div class="neon-modal__glow" aria-hidden="true"></div>
          <div style="display:flex; align-items:center; justify-content:space-between; gap:8px; margin-bottom:8px;">
            <div>
              <div class="neon-modal__title">${(data.cell.label || 'Selected cell')} — ${data.cell.count} entr${data.cell.count===1?'y':'ies'}</div>
              <div class="neon-modal__message" style="opacity:.85;">Pleasantness ${data.cell.x+1}, Energy ${data.cell.y+1}</div>
            </div>
            <button type="button" aria-label="Close" class="btn" id="hm-close-btn">Close</button>
          </div>
          <div style="border:1px solid rgba(255,255,255,0.08); border-radius:12px; padding:10px; background:#121418; box-shadow: inset 0 1px 0 rgba(255,255,255,0.04);">
            ${data.entries.length ? '<ul id="hm-list" style="list-style:none; margin:0; padding:0; display:grid; gap:8px; max-height:60vh; overflow:auto;"></ul>' : '<div style="padding:16px; text-align:center; color:#cfe7ff;">No entries</div>'}
          </div>
        `;
        wrap.appendChild(backdrop);
        wrap.appendChild(panel);
        root.appendChild(wrap);
        function onEsc(e){ if (e.key === 'Escape'){ e.preventDefault(); cleanup(); } }
        function cleanup(){ document.removeEventListener('keydown', onEsc); closeModal(wrap); }
        backdrop.addEventListener('click', cleanup);
        const closeBtn = panel.querySelector('#hm-close-btn');
        if (closeBtn) closeBtn.addEventListener('click', cleanup);
        document.addEventListener('keydown', onEsc);
        const list = panel.querySelector('#hm-list');
        if (list){
          const fmt = new Intl.DateTimeFormat(undefined, { dateStyle: 'medium', timeStyle: 'short' });
          for (const e of data.entries){
            const li = document.createElement('li');
            li.style.padding = '10px 12px';
            li.style.border = '1px solid rgba(255,255,255,0.06)';
            li.style.borderRadius = '10px';
            li.style.background = '#0f1217';
            const d = e.chosen_at ? new Date(e.chosen_at) : null;
            const when = d ? fmt.format(d) : (e.created_at ? fmt.format(new Date(e.created_at)) : 'Unknown time');
            const mood = e.label ? `<span style="opacity:.9"> — ${e.label}</span>` : '';
            li.innerHTML = `<div><strong>${when}</strong>${mood}</div>`;
            list.appendChild(li);
          }
        }
      }
      function attachCellHandlers(){
        const grids = document.querySelectorAll('.grid');
        for (const grid of grids){
          grid.addEventListener('click', async (ev) => {
            const cell = ev.target.closest('.cell');
            if (!cell || !grid.contains(cell)) return;
            const count = parseInt(cell.dataset.count || '0', 10);
            if (!count) return;
            const x = parseInt(cell.dataset.x, 10); const y = parseInt(cell.dataset.y, 10);
            const qs = new URLSearchParams();
            qs.set('x', String(x)); qs.set('y', String(y));
            const df = grid.dataset.dateFrom; const dt = grid.dataset.dateTo; const tf = grid.dataset.timeFrom; const tt = grid.dataset.timeTo;
            if (df) qs.set('date_from', df); if (dt) qs.set('date_to', dt); if (tf) qs.set('time_from', tf); if (tt) qs.set('time_to', tt);
            try {
              const res = await fetch(`/api/cell-entries?${qs.toString()}`);
              const data = await res.json();
              if (!data.ok) { console.warn('Failed to load entries', data); return; }
              openDetailsModal(cell, data);
            } catch (e) { console.error(e); }
          });
        }
      }
      if (document.readyState === 'loading') { document.addEventListener('DOMContentLoaded', attachCellHandlers); } else { attachCellHandlers(); }
    })();
  </script>
  <script>
    // Ensure no footer element exists on this dashboard page
    (function(){
      const removeFooter = () => {
        const f = document.querySelector('footer.footer');
        if (f) f.remove();
      };
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', removeFooter);
      } else {
        removeFooter();
      }
    })();
  </script>
</body>
</html>
