{% extends "base.html" %}
{% block title %}Student Dashboard{% endblock %}
{% block head %}
  <style>
    .dash-container { max-width: 1100px; margin: 0 auto; padding: 16px; }
    .dash-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 16px; }
    .filters { display: grid; grid-template-columns: repeat(4, minmax(140px, 1fr)); gap: 8px; margin: 12px 0 20px; }
    .stats { display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; margin-bottom: 20px; }
    .card { background: #1f2227; color: #e8eaeF; padding: 12px; border-radius: 10px; box-shadow: 0 6px 22px rgba(0,0,0,0.45), inset 0 1px 0 rgba(255,255,255,0.06); }
    .grid .cell { position: relative; }
    .heat-count { position: absolute; right: 6px; bottom: 4px; font-size: 12px; color: #fff; text-shadow: 0 1px 2px rgba(0,0,0,0.8); }
    .header-actions { display: flex; align-items: center; gap: 8px; }
    .link-btn { color: #72d5ff; text-decoration: none; border: 1px solid #3a3f47; padding: 6px 10px; border-radius: 8px; }
    .filter-form label { font-size: 12px; opacity: .8; display:block; margin-bottom:4px; }
    .filter-form input { width: 100%; padding: 6px 8px; border-radius: 8px; border: 1px solid #3a3f47; background: #121418; color: #e8eaef; }
    .filter-actions { grid-column: span 4; display: flex; gap: 8px; }
    .btn { background: #2f3540; color: #e8eaef; border: 1px solid #3a3f47; padding: 8px 12px; border-radius: 8px; cursor: pointer; }

    /* Collapsible filter styles */
    .filter-collapsible { border: 1px solid #333842; border-radius: 10px; background: #1b1f25; padding: 8px 10px; }
    .filter-collapsible > summary { list-style: none; cursor: pointer; font-weight: 600; color: #e8eaef; outline: none; }
    .filter-collapsible > summary::-webkit-details-marker { display: none; }
    .filter-collapsible[open] { padding-bottom: 10px; }
    .filter-collapsible .filters { margin-top: 10px; }

    /* Stats grouping sections */
    .stat-sections { display: grid; gap: 14px; margin-bottom: 20px; }
    .stat-section { border: 1px solid #333842; border-radius: 12px; padding: 10px; background: #1b1f25; }
    .stat-section.energy-theme { border-color: rgba(74, 201, 129, 0.45); background: linear-gradient(180deg, rgba(74,201,129,0.08), transparent 60%) #1b1f25; }
    .stat-section.pleasant-theme { border-color: rgba(246, 223, 95, 0.5); background: linear-gradient(180deg, rgba(246,223,95,0.10), transparent 60%) #1b1f25; }
    .section-title { margin: 0 0 8px; font-size: 16px; opacity: .95; }
    .stat-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
    .stat-stack { display: grid; gap: 8px; }
    @media (max-width: 900px) { .stat-grid { grid-template-columns: repeat(2, 1fr); } }
    @media (max-width: 580px) { .stat-grid { grid-template-columns: 1fr; } }
    /* Hide footer on dashboard pages */
    .footer { display: none !important; }
  </style>
{% endblock %}
{% block content %}
  <div class="dash-container">
    <div class="dash-header">
      <h1>Student Dashboard</h1>
      <div class="header-actions">
        <a class="link-btn" href="{{ url_for('home') }}">Home</a>
        <form method="post" action="{{ url_for('logout_view') }}">
          <button type="submit" class="btn">Logout</button>
        </form>
      </div>
    </div>


    <div class="stats">
      <div class="card"><strong>Most common mood:</strong> {{ stats.most_common_mood or '—' }}</div>
    </div>

    {% set month_names = ['', 'January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'] %}
    {% set day_names = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'] %}
    {% macro hour12(h) -%}
      {%- if h is not none -%}
        {{ (h % 12) if (h % 12) else 12 }}:00 {{ 'PM' if h >= 12 else 'AM' }}
      {%- else -%}
        —
      {%- endif -%}
    {%- endmacro %}

    <div class="stat-sections">
      <section class="stat-section energy-theme" aria-labelledby="energy-stats-title">
        <h3 id="energy-stats-title" class="section-title">Energy stats</h3>
        <div class="stat-grid">
          <div class="stat-stack">
            <div class="card"><strong>Highest energy month:</strong> {{ month_names[stats.month_high_energy] if stats.month_high_energy is not none else '—' }}</div>
            <div class="card"><strong>Lowest energy month:</strong> {{ month_names[stats.month_low_energy] if stats.month_low_energy is not none else '—' }}</div>
          </div>
          <div class="stat-stack">
            <div class="card"><strong>Highest energy day:</strong> {{ day_names[stats.day_high_energy] if stats.day_high_energy is not none else '—' }}</div>
            <div class="card"><strong>Lowest energy day:</strong> {{ day_names[stats.day_low_energy] if stats.day_low_energy is not none else '—' }}</div>
          </div>
          <div class="stat-stack">
            <div class="card"><strong>Highest energy hour:</strong> {{ hour12(stats.time_high_energy) }}</div>
            <div class="card"><strong>Lowest energy hour:</strong> {{ hour12(stats.time_low_energy) }}</div>
          </div>
        </div>
      </section>

      <section class="stat-section pleasant-theme" aria-labelledby="pleasant-stats-title">
        <h3 id="pleasant-stats-title" class="section-title">Pleasantness stats</h3>
        <div class="stat-grid">
          <div class="stat-stack">
            <div class="card"><strong>Most pleasant month:</strong> {{ month_names[stats.month_most_pleasant] if stats.month_most_pleasant is not none else '—' }}</div>
            <div class="card"><strong>Least pleasant month:</strong> {{ month_names[stats.month_least_pleasant] if stats.month_least_pleasant is not none else '—' }}</div>
          </div>
          <div class="stat-stack">
            <div class="card"><strong>Most pleasant day:</strong> {{ day_names[stats.day_most_pleasant] if stats.day_most_pleasant is not none else '—' }}</div>
            <div class="card"><strong>Least pleasant day:</strong> {{ day_names[stats.day_least_pleasant] if stats.day_least_pleasant is not none else '—' }}</div>
          </div>
          <div class="stat-stack">
            <div class="card"><strong>Most pleasant hour:</strong> {{ hour12(stats.time_most_pleasant) }}</div>
            <div class="card"><strong>Least pleasant hour:</strong> {{ hour12(stats.time_least_pleasant) }}</div>
          </div>
        </div>
      </section>
    </div>

    <div class="card" style="margin-bottom:12px;">
      <h3 style="margin-bottom:8px;">Your Trend</h3>
      <pre class="info-pre" style="display:none; white-space: pre-wrap; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, 'Liberation Mono', monospace; font-size: 12px; line-height: 1.35; color:#d7dbea; background: #16191f; padding:10px; border-radius:8px; border:1px solid #2a2f38; max-height: 260px; overflow:auto;">
Energy
Enraged
Panicked
Stressed
Jittery
Shocked
Surprised
Upbeat
Festive
Exhilarated
Ecstatic
Livid
Furious
Frustrated
Tense
Stunned
Hyper
Cheerful
Excited
Inspired
Elated
Fuming
Frightened
Angry
Nervous
Restless
Energized
Lively
Happy
Optimistic
Enthusiastic
Anxious
Apprehensive
Worried
Irritated
Annoyed
Pleased
Focused
Motivated
Proud
Thrilled
Dreadful
Troubled
Concerned
Uneasy
Peeved
1
Pleasant
1
Joyful
Hopeful
Playful
Blissful
Disgusted
Glum
Dissapointed
Down
Apathetic
At Ease
Easygoing
Content
Loving
Fullfilled
Pessimistic
Morose
Disheartened
Discouraged
Bored
Chill
Secure
Satisfied
Grateful
Touched
Alienated
Miserable
Sad
Lonely
Tired
Relaxed
1
Restful
Calm
Blessed
Balanced
Despondent
Depressed
Sullen
Exhausted
Fatigued
Mellow
Thoughtful
Peaceful
Comfortable
Carefree
1
Despair
1
Hopeless
Desolate
Spent
Drained
Sleepy
Complacent
Tranquil
Cozy
Serene
1
Pleasantness
      </pre>
      {% if stats.avg_x is not none %}
      <div class="avg-legend" aria-live="polite" style="margin-top:8px; font-size: 39px; line-height: 1.2;">
        {% set quad = stats.avg_quadrant or '' %}
        {% if quad == 'red' %}{% set dot_class = 'q-red' %}
        {% elif quad == 'yellow' %}{% set dot_class = 'q-yellow' %}
        {% elif quad == 'blue' %}{% set dot_class = 'q-blue' %}
        {% else %}{% set dot_class = 'q-green' %}{% endif %}
        <span class="dot {{ dot_class }}" style="width:30px; height:30px;"></span>
        <span class="label">Overall: <strong>{{ stats.avg_quadrant_label }}</strong>{% if stats.avg_meaning %} — {{ stats.avg_meaning }}{% endif %}</span>
      </div>
      {% endif %}
    </div>

    <div class="card">
      <h3 style="margin-bottom:10px">Your heatmap</h3>
      <div class="axes-layout">
        <div class="axis-y" aria-hidden="true">
          <svg class="axis-y-svg" viewBox="0 0 16 100" preserveAspectRatio="none" focusable="false" aria-hidden="true">
            <defs>
              <marker id="arrowhead-y" markerWidth="6" markerHeight="6" refX="3" refY="3" orient="auto" markerUnits="strokeWidth">
                <path d="M0,0 L6,3 L0,6 z" fill="currentColor"></path>
              </marker>
            </defs>
            <line x1="8" y1="6" x2="8" y2="94" stroke="currentColor" stroke-width="2" marker-start="url(#arrowhead-y)" marker-end="url(#arrowhead-y)"></line>
          </svg>
          <div class="axis-label axis-label-y">Energy</div>
        </div>
        <div class="grid-wrapper">
          <div class="grid" role="grid" aria-label="Heatmap grid"
               data-avg-tx="{{ stats.avg_tx if stats.avg_tx is not none else '' }}"
               data-avg-ty="{{ stats.avg_ty if stats.avg_ty is not none else '' }}"
               data-scope="student">
            {% set maxc = stats.max_count or 0 %}
            {% for y in range(size) %}
              <div class="row" role="row">
                {% for x in range(size) %}
                  {% set c = stats.heatmap[y][x] %}
                  {% set t = (c / maxc) if maxc else 0 %}
                  {% set label = grid[y][x] %}
                  <div class="cell" data-x="{{ x }}" data-y="{{ y }}" data-intensity="{{ t }}" data-count="{{ c }}" data-cell-label="{{ label }}">
                    <span class="cell-label">{{ label }}</span>
                    {% if c %}<span class="heat-count">{{ c }}</span>{% endif %}
                  </div>
                {% endfor %}
              </div>
            {% endfor %}
          </div>
        </div>
        <div class="axis-x" aria-hidden="true">
          <svg class="axis-x-svg" viewBox="0 0 100 16" preserveAspectRatio="none" focusable="false" aria-hidden="true">
            <defs>
              <marker id="arrowhead-x" markerWidth="6" markerHeight="6" refX="3" refY="3" orient="auto" markerUnits="strokeWidth">
                <path d="M0,0 L6,3 L0,6 z" fill="currentColor"></path>
              </marker>
            </defs>
            <line x1="6" y1="8" x2="94" y2="8" stroke="currentColor" stroke-width="2" marker-start="url(#arrowhead-x)" marker-end="url(#arrowhead-x)"></line>
          </svg>
          <div class="axis-label axis-label-x">Pleasantness</div>
        </div>
      </div>
    </div>
  </div>
{% endblock %}
{% block scripts %}
  <script src="{{ url_for('static', filename='js/heatmap-colors.js') }}"></script>
  <script src="{{ url_for('static', filename='js/cell-modal.js') }}"></script>
  <script>
    (function() {
      try { document.querySelectorAll('marker#arrowhead-x, marker#arrowhead-y').forEach(function(m){ m.setAttribute('orient','auto-start-reverse'); }); } catch(e){}
      var size = Number('{{ size|tojson }}');
      function ready(fn){ if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', fn); else fn(); }
      ready(function(){
        window.initHeatmap(size);
        window.initCellModal();
        var f = document.querySelector('footer.footer');
        if (f) f.remove();
      });
    })();
  </script>
{% endblock %}
